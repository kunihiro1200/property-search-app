# 買主リスト - 近隣物件検索の拡張 - タスクリスト

## 📋 概要

買主詳細ページの近隣物件検索機能を拡張し、3つの検索方法（所在地ベース、距離ベース、配信エリアベース）を統合する。

---

## ✅ タスク一覧

### Phase 1: バックエンド - ヘルパーメソッドの実装

- [x] 1.1 距離計算メソッドの実装
  - [x] `calculateDistance(lat1, lng1, lat2, lng2)`メソッドを実装
  - [ ] `toRadians(degrees)`メソッドを実装
  - [ ] Haversine公式を使用して2点間の距離を計算
  - [ ] 小数点第1位まで丸める

- [x] 1.2 配信エリア関連メソッドの実装
  - [ ] `parseDistributionAreas(distributionAreas)`メソッドを実装
  - [ ] カンマ区切りの文字列を配列に変換
  - [ ] 空文字列や空白を除外
  - [ ] `findCommonAreas(areas1, areas2)`メソッドを実装
  - [ ] 2つの配列の共通要素を返す

- [x] 1.3 価格帯計算メソッドの実装
  - [ ] `calculatePriceRange(price)`メソッドを実装
  - [ ] 価格帯に応じた最小値・最大値を返す
  - [ ] 4つの価格帯（1000万円未満、1000万～2999万円、3000万～4999万円、5000万円以上）

- [x] 1.4 市区町村・町名抽出メソッドの実装（既存）
  - [ ] `extractCityAndTown(address)`メソッドを確認
  - [ ] 既存の実装をそのまま使用

### Phase 2: バックエンド - 検索メソッドの実装

- [x] 2.1 所在地ベース検索の実装（既存の修正）
  - [ ] `searchByLocation(baseProperty, commonFilters)`メソッドを実装
  - [ ] 既存のロジックを新しいメソッドに移動
  - [ ] ステータス条件を更新（"非公開（配信メールのみ）"を追加）
  - [ ] `matched_by: ['location']`を追加

- [x] 2.2 距離ベース検索の実装（新規）
  - [ ] `searchByDistance(baseProperty, commonFilters)`メソッドを実装
  - [ ] 基準物件の座標データをチェック
  - [ ] 座標データがある物件を取得
  - [ ] 共通フィルタ（価格帯、種別、ステータス）を適用
  - [ ] 各物件との距離を計算
  - [ ] 半径3km以内の物件をフィルタリング
  - [ ] `matched_by: ['distance']`と`distance_km`を追加

- [x] 2.3 配信エリアベース検索の実装（新規）
  - [ ] `searchByDistributionArea(baseProperty, commonFilters)`メソッドを実装
  - [ ] 基準物件の配信エリアをチェック
  - [ ] 配信エリアがある物件を取得
  - [ ] 共通フィルタ（価格帯、種別、ステータス）を適用
  - [ ] 各物件の配信エリアをパース
  - [ ] 共通エリアを検出
  - [ ] 共通エリアがある物件をフィルタリング
  - [ ] `matched_by: ['distribution_area']`と`common_areas`を追加

### Phase 3: バックエンド - 結果の統合

- [x] 3.1 結果統合メソッドの実装
  - [ ] `mergeResults(locationResults, distanceResults, distributionAreaResults)`メソッドを実装
  - [ ] 物件番号をキーとしたMapを作成
  - [ ] 3つの検索結果を統合
  - [ ] 重複する物件の`matched_by`を統合
  - [ ] `distance_km`と`common_areas`を追加

- [x] 3.2 ソートメソッドの実装
  - [ ] `sortResults(properties)`メソッドを実装
  - [ ] 配信日で降順ソート
  - [ ] 配信日が同じ場合は物件番号で降順ソート

### Phase 4: バックエンド - getNearbyPropertiesメソッドの拡張

- [x] 4.1 メソッドの拡張
  - [ ] `getNearbyProperties(propertyNumber)`メソッドを拡張
  - [ ] 基準物件を取得
  - [ ] 共通フィルタを準備（価格帯、種別）
  - [ ] 3つの検索メソッドを並列実行（Promise.all）
  - [ ] 結果を統合
  - [ ] 結果をソート
  - [ ] レスポンスに`searchMethods`を追加

- [x] 4.2 レスポンス形式の更新
  - [ ] `baseProperty`を返す
  - [ ] `nearbyProperties`を返す（統合・ソート済み）
  - [ ] `searchMethods`を返す（各検索方法の件数）

### Phase 5: テスト

- [ ] 5.1 ユニットテストの作成
  - [ ] `calculateDistance`のテスト
  - [ ] `parseDistributionAreas`のテスト
  - [ ] `findCommonAreas`のテスト
  - [ ] `calculatePriceRange`のテスト

- [ ] 5.2 統合テストの作成
  - [ ] `getNearbyProperties`の統合テスト
  - [ ] 所在地ベース検索のテスト
  - [ ] 距離ベース検索のテスト
  - [ ] 配信エリアベース検索のテスト
  - [ ] 結果統合のテスト

- [x] 5.3 手動テスト
  - [ ] 座標データがある物件でテスト
  - [ ] 座標データがない物件でテスト
  - [ ] 配信エリアがある物件でテスト
  - [ ] 配信エリアがない物件でテスト
  - [ ] 3つの検索方法が正しく統合されることを確認

### Phase 6: ドキュメント

- [ ] 6.1 コードコメントの追加
  - [ ] 各メソッドにJSDocコメントを追加
  - [ ] 複雑なロジックにインラインコメントを追加

- [ ] 6.2 README更新（オプション）
  - [ ] 近隣物件検索の拡張について記載
  - [ ] 3つの検索方法について説明

### Phase 7: デプロイ

- [ ] 7.1 ローカル環境での動作確認
  - [ ] バックエンドを起動
  - [ ] APIエンドポイントをテスト
  - [ ] レスポンスを確認

- [ ] 7.2 本番環境へのデプロイ
  - [ ] バックエンドをデプロイ
  - [ ] 動作確認
  - [ ] 問題がなければ完了

---

## 📝 実装の優先順位

### 高優先度（必須）

1. Phase 1: ヘルパーメソッドの実装
2. Phase 2: 検索メソッドの実装
3. Phase 3: 結果の統合
4. Phase 4: getNearbyPropertiesメソッドの拡張

### 中優先度（推奨）

5. Phase 5: テスト
6. Phase 6: ドキュメント

### 低優先度（オプション）

7. Phase 7: デプロイ

---

## 🎯 完了条件

### Phase 1完了条件

- [ ] 距離計算メソッドが正しく動作する
- [ ] 配信エリア関連メソッドが正しく動作する
- [ ] 価格帯計算メソッドが正しく動作する

### Phase 2完了条件

- [ ] 所在地ベース検索が正しく動作する
- [ ] 距離ベース検索が正しく動作する
- [ ] 配信エリアベース検索が正しく動作する
- [ ] 各検索方法が共通フィルタを適用している

### Phase 3完了条件

- [ ] 3つの検索結果が正しく統合される
- [ ] 重複する物件が除外される
- [ ] 結果が正しくソートされる

### Phase 4完了条件

- [ ] `getNearbyProperties`メソッドが拡張される
- [ ] レスポンスに`searchMethods`が含まれる
- [ ] 既存のAPIエンドポイントが動作し続ける

### Phase 5完了条件

- [ ] ユニットテストが全て通過する
- [ ] 統合テストが全て通過する
- [ ] 手動テストで問題がない

### Phase 6完了条件

- [ ] コードコメントが追加される
- [ ] ドキュメントが更新される（オプション）

### Phase 7完了条件

- [ ] ローカル環境で動作確認が完了する
- [ ] 本番環境へのデプロイが完了する
- [ ] 本番環境で動作確認が完了する

---

## 📊 進捗管理

### 全体進捗

- Phase 1: 0/4 タスク完了
- Phase 2: 0/3 タスク完了
- Phase 3: 0/2 タスク完了
- Phase 4: 0/2 タスク完了
- Phase 5: 0/3 タスク完了
- Phase 6: 0/2 タスク完了
- Phase 7: 0/2 タスク完了

**合計**: 0/18 タスク完了（0%）

---

## 🚨 注意事項

### 1. 後方互換性

- 既存のAPIエンドポイントを変更しない
- 既存のフロントエンドが動作し続けることを確認
- レスポンス形式を拡張するが、既存のフィールドは維持

### 2. パフォーマンス

- 3つの検索方法を並列実行（Promise.all）
- データベースクエリを最適化
- 必要に応じてキャッシュを導入（将来的な拡張）

### 3. エラーハンドリング

- 座標データがない場合は距離ベース検索をスキップ
- 配信エリアがない場合は配信エリアベース検索をスキップ
- エラーログを出力

### 4. テスト

- ユニットテストを作成
- 統合テストを作成
- 手動テストで動作確認

---

## 📚 関連ドキュメント

- `.kiro/specs/buyer-nearby-properties-distance-based/requirements.md` - 要件定義
- `.kiro/specs/buyer-nearby-properties-distance-based/design.md` - 設計書
- `.kiro/steering/buyer-table-column-definition.md` - 買主テーブルのカラム定義
- `backend/src/services/BuyerService.ts` - 買主サービス

---

**作成日**: 2026年2月11日  
**最終更新日**: 2026年2月11日
