# 買主リスト - 近隣物件検索の拡張（距離ベース + 配信エリア）

## 📋 概要

買主詳細ページの近隣物件検索機能を拡張し、以下の3つの検索方法を提供する：

1. **既存の所在地ベース検索**（現在の実装）
2. **距離ベース検索**（新規）- 半径3km以内
3. **配信エリア番号ベース検索**（新規）

## 🎯 目標

買主に提案できる近隣物件の数を増やし、より柔軟な物件検索を実現する。

## 📊 現在の問題

### 問題1: 所在地ベース検索の限界

現在の実装では、基準物件の「市区町村+町名」（例：大分市明野）で文字列マッチングを行っているため、以下の問題がある：

- **物件数が少なすぎる**: 「大分市明野」で検索すると、近くにある「大分市大在」などは除外される
- **地理的な近さを考慮していない**: 実際には近い物件でも、町名が異なると検索されない

### 問題2: 配信エリアの活用不足

`property_listings`テーブルには`distribution_areas`カラム（配信エリア番号、例："①,②,③"）があるが、近隣物件検索では活用されていない。

## ✅ 要件

### 1. 距離ベース検索の追加

#### 1.1 検索条件

基準物件から**半径3km以内**の物件を検索する。

**検索条件**:
- ✅ **距離**: 基準物件から半径3km以内（Haversine公式で計算）
- ✅ **価格帯**: 基準物件の価格に応じた範囲（既存と同じ）
- ✅ **種別**: 基準物件と同じ種別（既存と同じ）
- ✅ **ステータス**: atbb_statusに"公開中"、"公開前"、または"非公開（配信メールのみ）"が含まれる
- ✅ **基準物件を除外**: 基準物件自身は結果に含めない

**価格帯の定義**（既存と同じ）:
- 1000万円未満: 0円 ～ 999万円
- 1000万～2999万円: 1000万円 ～ 2999万円
- 3000万～4999万円: 3000万円 ～ 4999万円
- 5000万円以上: 5000万円 ～ 上限なし

#### 1.2 座標データの利用

`property_listings`テーブルの`latitude`と`longitude`カラムを使用する。

**前提条件**:
- 基準物件に座標データ（latitude, longitude）が存在すること
- 検索対象物件に座標データが存在すること
- 座標データがない物件は検索結果から除外される

#### 1.3 距離計算

**Haversine公式**を使用して、2点間の直線距離を計算する。

```typescript
// 疑似コード
function calculateDistance(lat1, lng1, lat2, lng2): number {
  // Haversine公式で距離（km）を計算
  return distanceInKm;
}
```

### 2. 配信エリア番号ベース検索の追加

#### 2.1 検索条件

基準物件の**配信エリア番号**に一致する物件を検索する。

**検索条件**:
- ✅ **配信エリア**: 基準物件の`distribution_areas`に含まれるエリア番号のいずれかに一致
- ✅ **価格帯**: 基準物件の価格に応じた範囲（既存と同じ）
- ✅ **種別**: 基準物件と同じ種別（既存と同じ）
- ✅ **ステータス**: atbb_statusに"公開中"、"公開前"、または"非公開（配信メールのみ）"が含まれる
- ✅ **基準物件を除外**: 基準物件自身は結果に含めない

**配信エリアの形式**:
- `distribution_areas`カラムは文字列型（例："①,②,③"）
- カンマ区切りで複数のエリア番号が格納されている
- エリア番号は①～㊿の丸数字

#### 2.2 配信エリアのマッチング

基準物件の配信エリア番号と、検索対象物件の配信エリア番号に**共通のエリアが1つでもあれば**マッチとする。

**例**:
- 基準物件: `distribution_areas = "①,②,③"`
- 検索対象物件A: `distribution_areas = "②,④,⑤"` → マッチ（②が共通）
- 検索対象物件B: `distribution_areas = "④,⑤,⑥"` → マッチしない

### 3. 検索方法の統合

#### 3.1 検索結果の統合

3つの検索方法（所在地ベース、距離ベース、配信エリアベース）の結果を統合し、重複を除外する。

**統合ロジック**:
1. 所在地ベース検索を実行
2. 距離ベース検索を実行
3. 配信エリアベース検索を実行
4. 3つの結果を統合し、重複する物件番号を除外
5. 統合結果を返す

#### 3.2 検索結果のソート

統合後の検索結果は、以下の順序でソートする：

1. **配信日**（降順）- 新しい物件が上位
2. **物件番号**（降順）- 同じ配信日の場合は物件番号が大きい順

### 4. APIエンドポイントの変更

#### 4.1 既存エンドポイント

`GET /api/buyers/:id/nearby-properties?propertyNumber=<物件番号>`

**変更内容**:
- レスポンスに検索方法の情報を追加
- 各物件がどの検索方法でマッチしたかを示す

**レスポンス例**:
```json
{
  "baseProperty": {
    "property_number": "AA13501",
    "address": "大分市明野東1-1-1",
    "latitude": 33.2381,
    "longitude": 131.6125,
    "distribution_areas": "①,②,③",
    "price": 25000000,
    "property_type": "戸建て"
  },
  "nearbyProperties": [
    {
      "property_number": "AA13502",
      "address": "大分市大在1-1-1",
      "price": 23000000,
      "property_type": "戸建て",
      "atbb_status": "公開中",
      "matched_by": ["distance", "distribution_area"],
      "distance_km": 2.5,
      "common_areas": ["①", "②"]
    }
  ],
  "searchMethods": {
    "location": 5,
    "distance": 12,
    "distribution_area": 8,
    "total": 18
  }
}
```

### 5. フロントエンドの変更

#### 5.1 買主詳細ページ

**変更なし** - 既存の「近隣物件」ボタンとカウント表示はそのまま

#### 5.2 近隣物件一覧ページ

**変更内容**:
- 検索方法の内訳を表示（オプション）
- 各物件がどの検索方法でマッチしたかを表示（オプション）

## 📝 受け入れ基準

### AC1: 距離ベース検索

- [ ] 基準物件から半径3km以内の物件を検索できる
- [ ] 座標データがない物件は検索結果から除外される
- [ ] 価格帯、種別、ステータスの条件が正しく適用される
- [ ] 基準物件自身は結果に含まれない

### AC2: 配信エリアベース検索

- [ ] 基準物件の配信エリア番号に一致する物件を検索できる
- [ ] 共通のエリア番号が1つでもあればマッチする
- [ ] 価格帯、種別、ステータスの条件が正しく適用される
- [ ] 基準物件自身は結果に含まれない

### AC3: 検索結果の統合

- [ ] 3つの検索方法の結果が統合される
- [ ] 重複する物件番号が除外される
- [ ] 検索結果が配信日と物件番号でソートされる

### AC4: APIレスポンス

- [ ] 各物件がどの検索方法でマッチしたかが返される
- [ ] 距離ベースでマッチした場合、距離（km）が返される
- [ ] 配信エリアベースでマッチした場合、共通エリア番号が返される
- [ ] 検索方法ごとの件数が返される

### AC5: 後方互換性

- [ ] 既存のAPIエンドポイントが動作し続ける
- [ ] 既存のフロントエンドが動作し続ける
- [ ] 既存の所在地ベース検索が動作し続ける

## 🚨 制約事項

### 1. 座標データの必須化

距離ベース検索を使用するには、物件に座標データ（latitude, longitude）が必要。

**対応**:
- 座標データがない物件は距離ベース検索の結果から除外される
- 所在地ベースと配信エリアベースの検索は引き続き動作する

### 2. 配信エリアデータの必須化

配信エリアベース検索を使用するには、物件に配信エリアデータ（distribution_areas）が必要。

**対応**:
- 配信エリアデータがない物件は配信エリアベース検索の結果から除外される
- 所在地ベースと距離ベースの検索は引き続き動作する

### 3. パフォーマンス

3つの検索方法を実行するため、処理時間が増加する可能性がある。

**対応**:
- データベースクエリを最適化する
- 必要に応じてキャッシュを導入する

## 📚 関連ドキュメント

- `.kiro/steering/buyer-table-column-definition.md` - 買主テーブルのカラム定義
- `.kiro/specs/walking-distance-calculation/` - 配信エリア計算機能
- `backend/src/services/PropertyDistributionAreaCalculator.ts` - 配信エリア計算サービス

## 🎯 成功指標

1. ✅ 近隣物件の検索結果が平均で**2倍以上**に増加する
2. ✅ 距離ベース検索で**半径3km以内**の物件が正しく検索される
3. ✅ 配信エリアベース検索で**共通エリア**の物件が正しく検索される
4. ✅ 既存の所在地ベース検索が引き続き動作する
5. ✅ APIレスポンスタイムが**3秒以内**

## 📋 要件のまとめ

買主リストの近隣物件検索機能を以下のように拡張します：

### 3つの検索方法

1. **所在地ベース**（既存）: 市区町村+町名の文字列マッチング
2. **距離ベース**（新規）: 半径3km以内の物件
3. **配信エリア番号ベース**（新規）: 共通の配信エリア番号を持つ物件

### 共通の検索条件

すべての検索方法で以下の条件を適用：
- 価格帯: 基準物件の価格に応じた範囲
- 種別: 基準物件と同じ種別
- ステータス: atbb_statusに"公開中"、"公開前"、または"非公開（配信メールのみ）"が含まれる

### 検索結果の統合

3つの検索方法の結果を統合し、重複を除外して返します。各物件がどの検索方法でマッチしたかも返します。

---

**作成日**: 2026年2月11日  
**作成理由**: 買主に提案できる近隣物件の数を増やすため
