# 買主削除同期機能 - 要件定義

## 1. 概要

スプレッドシートで削除された買主をデータベースからも自動的に削除する機能を実装します。

## 2. 背景

### 現在の状況
- 新規作成: データベース → スプレッドシート（同期される）
- 更新: データベース → スプレッドシート（同期される）
- 削除: **同期されない**（スプレッドシートで削除してもデータベースに残る）

### ユーザーの要望
- スプレッドシートで削除したデータはデータベースから完全削除してよい
- もとに戻すことはない
- 論理削除ではなく物理削除を使用

## 3. ユーザーストーリー

### US-1: スプレッドシート削除の自動検出
**As a** システム管理者  
**I want** スプレッドシートで削除された買主を自動的に検出する  
**So that** データベースとスプレッドシートの整合性を保つことができる

**受け入れ基準:**
- スプレッドシートから買主番号一覧を取得できる
- データベースから買主番号一覧を取得できる
- データベースにあるがスプレッドシートにない買主を検出できる
- 検出された買主のリストをログに出力できる

### US-2: 削除対象の確認
**As a** システム管理者  
**I want** 削除対象の買主を事前に確認できる  
**So that** 誤って重要なデータを削除することを防ぐことができる

**受け入れ基準:**
- 削除対象の買主番号をリスト表示できる
- 削除対象の買主数を表示できる
- 削除実行前に確認プロンプトを表示できる

### US-3: データベースからの物理削除
**As a** システム管理者  
**I want** 削除対象の買主をデータベースから物理削除する  
**So that** 不要なデータを完全に削除できる

**受け入れ基準:**
- 削除対象の買主をデータベースから物理削除できる
- 削除された買主数をログに出力できる
- 削除エラーが発生した場合、エラーメッセージを表示できる
- 削除後、データベースとスプレッドシートの整合性を確認できる

### US-4: 手動実行スクリプト
**As a** システム管理者  
**I want** 削除同期を手動で実行できるスクリプトを使用する  
**So that** 必要なときに削除同期を実行できる

**受け入れ基準:**
- `npx ts-node backend/sync-deleted-buyers.ts`で実行できる
- 削除対象の買主を確認してから削除を実行できる
- ドライランモード（削除せずに確認のみ）を使用できる

### US-5: BuyerServiceへの削除機能追加
**As a** 開発者  
**I want** BuyerServiceに削除機能を追加する  
**So that** 他の機能からも買主を削除できる

**受け入れ基準:**
- `BuyerService.delete(buyerNumber: string)`メソッドを実装できる
- 削除時に監査ログを記録できる
- 削除時にスプレッドシートからも削除できる（オプション）

## 4. 機能要件

### FR-1: 削除対象の検出
- スプレッドシートから買主番号一覧を取得する（E列、5行目から）
- データベースから買主番号一覧を取得する
- データベースにあるがスプレッドシートにない買主を検出する

### FR-2: 削除対象の確認
- 削除対象の買主番号をリスト表示する
- 削除対象の買主数を表示する
- 削除実行前に確認プロンプトを表示する

### FR-3: 物理削除
- 削除対象の買主をデータベースから物理削除する
- 削除された買主数をログに出力する
- 削除エラーが発生した場合、エラーメッセージを表示する

### FR-4: 削除後の確認
- 削除後、データベースとスプレッドシートの整合性を確認する
- 削除後の買主数を表示する

### FR-5: ドライランモード
- `--dry-run`オプションで削除せずに確認のみを実行できる
- ドライランモードでは削除対象の買主をリスト表示するのみ

## 5. 非機能要件

### NFR-1: パフォーマンス
- 削除処理は10秒以内に完了する（削除対象が100件以下の場合）
- スプレッドシートAPIの呼び出しは最小限に抑える

### NFR-2: 安全性
- 削除実行前に確認プロンプトを表示する
- ドライランモードで事前に確認できる
- 削除エラーが発生した場合、処理を中断する

### NFR-3: ログ
- 削除対象の買主番号をログに出力する
- 削除された買主数をログに出力する
- 削除エラーが発生した場合、エラーメッセージをログに出力する

## 6. 制約事項

### 制約1: スプレッドシートの1行目は絶対に触らない
- ヘッダー行の読み取り（`getHeaders()`以外）、更新、削除、挿入は全て禁止
- データは5行目から開始（1-4行目はヘッダーと説明）

### 制約2: 買主番号はE列
- スプレッドシートの買主番号はE列に格納されている
- 5行目から開始

### 制約3: 物理削除のみ
- 論理削除（`deleted_at`フラグ）は使用しない
- データベースから完全に削除する

### 制約4: ローカル環境のみ
- 現在はローカル環境でテスト中
- 本番環境への適用は後日検討

## 7. 実装ファイル

### 新規作成
- `backend/sync-deleted-buyers.ts` - 削除同期スクリプト（手動実行用）

### 変更
- `backend/src/services/BuyerService.ts` - 削除機能を追加

### 参考
- `backend/check-deleted-buyers.ts` - 削除対象の確認スクリプト（既存）
- `backend/src/services/GoogleSheetsClient.ts` - スプレッドシート操作の基本クラス

## 8. テストシナリオ

### TS-1: 削除対象の検出
1. スプレッドシートから買主番号一覧を取得
2. データベースから買主番号一覧を取得
3. 差分を検出
4. 削除対象の買主番号をリスト表示

### TS-2: ドライランモード
1. `npx ts-node backend/sync-deleted-buyers.ts --dry-run`を実行
2. 削除対象の買主番号をリスト表示
3. 削除は実行されない

### TS-3: 削除実行
1. `npx ts-node backend/sync-deleted-buyers.ts`を実行
2. 削除対象の買主番号をリスト表示
3. 確認プロンプトで"yes"を入力
4. 削除を実行
5. 削除された買主数を表示

### TS-4: 削除後の確認
1. 削除実行後、`npx ts-node backend/check-deleted-buyers.ts`を実行
2. 削除対象の買主が0件であることを確認

## 9. リスク

### リスク1: 誤削除
- **リスク**: 重要なデータを誤って削除する可能性がある
- **対策**: 削除実行前に確認プロンプトを表示、ドライランモードで事前確認

### リスク2: スプレッドシートとデータベースの不整合
- **リスク**: スプレッドシートとデータベースの買主番号が一致しない場合、誤った買主を削除する可能性がある
- **対策**: 削除前に買主番号を確認、削除後に整合性を確認

### リスク3: 削除エラー
- **リスク**: 削除中にエラーが発生し、一部の買主のみが削除される可能性がある
- **対策**: エラーが発生した場合は処理を中断、エラーメッセージをログに出力

## 10. 将来の拡張

### 拡張1: 自動同期サービスへの統合
- `EnhancedAutoSyncService`に削除検出ロジックを追加
- 5分ごとの自動同期で削除を検出して実行

### 拡張2: 削除履歴の記録
- 削除された買主の履歴を別テーブルに記録
- 削除日時、削除理由、削除者を記録

### 拡張3: 論理削除のサポート
- `deleted_at`フラグを使用した論理削除をサポート
- 削除された買主を一定期間保持してから物理削除

## 11. 参考資料

- `.kiro/steering/spreadsheet-header-protection-rule.md` - スプレッドシートヘッダー保護ルール
- `.kiro/steering/buyer-table-column-definition.md` - 買主テーブルのカラム定義
- `backend/check-deleted-buyers.ts` - 削除対象の確認スクリプト

---

**作成日**: 2026年2月14日  
**作成者**: Kiro AI  
**ステータス**: Draft
