# 公開物件サイト - コメント表示修正 タスクリスト

## 🚨 Phase 0: 最優先 - エラー時のnull上書き問題を修正

### 0.1 PropertyListingSyncServiceの修正
- [x] `backend/src/services/PropertyListingSyncService.ts`の`updatePropertyDetailsFromSheets()`メソッドを修正
- [x] エラー時に`null`ではなく`undefined`を返すように変更
- [x] `upsertPropertyDetails()`に渡す前に、`undefined`のフィールドを除外
- [x] ローカル環境でテスト実行

### 0.2 修正内容の確認
- [x] 修正後のコードをレビュー
- [x] エラーが発生した場合、既存のコメントデータが保持されることを確認
- [x] ログ出力を確認

### 0.3 本番環境へのデプロイ
- [x] 変更をコミット
- [x] Vercelに自動デプロイ
- [x] デプロイ完了を確認

### 0.4 影響範囲の確認
- [x] 画像表示に影響がないことを確認
- [x] お問合せ送信に影響がないことを確認
- [x] バッジ表示に影響がないことを確認
- [x] 並び順に影響がないことを確認
- [x] 影響範囲分析ドキュメントを作成（`.kiro/specs/public-property-comment-display-fix/impact-analysis.md`）

### 0.5 数日後の確認方法をドキュメント化
- [x] 確認ガイドを作成（`.kiro/restore-guides/comment-data-stability-check.md`）
- [x] 確認スクリプトの使用方法を記載
- [x] KIROへの依頼方法を記載

### 0.6 動作確認（数日後に実行）
- [ ] 数日後にAA5564のコメントデータが消失していないか確認
- [ ] 他の物件でもコメントデータが保持されているか確認
- [ ] `npx ts-node backend/check-comment-data-stability.ts`を実行

## Phase 1: 原因調査と事前同期

### 1.1 Vercelログの確認
- [ ] Vercelダッシュボードで`/complete`エンドポイントのログを確認
- [ ] 自動同期が実行されているか確認
- [ ] エラーが発生しているか確認

### 1.2 環境変数の確認
- [ ] Vercel環境変数で`GOOGLE_SERVICE_ACCOUNT_JSON`が設定されているか確認
- [ ] その他の必要な環境変数が設定されているか確認

### 1.3 AA5564のコメントデータを手動で同期
- [ ] Google Sheets APIクォータ制限が解除されるまで待機（数分）
- [ ] `backend/sync-aa5564-comments.ts`を実行してコメントデータを同期
- [ ] `backend/check-aa5564-comments.ts`を実行して同期結果を確認

### 1.4 他の物件のコメントデータも確認
- [ ] コメントデータが空の物件を特定
- [ ] 全物件のコメントデータ状況を確認するスクリプトを作成
- [ ] 実行して結果を確認

## Phase 2: 事前同期バッチの実装

### 2.1 全物件のコメントデータを同期するスクリプトを作成
- [ ] `backend/sync-all-property-comments.ts`を作成
- [ ] コメントデータが空の物件のみを対象にする
- [ ] APIクォータ制限を回避するため、1秒ごとに実行
- [ ] 進捗状況をログに出力

### 2.2 スクリプトを実行して全物件を同期
- [ ] ローカル環境で実行
- [ ] エラーが発生した物件をログに記録
- [ ] 同期結果を確認

### 2.3 定期実行の設定（オプション）
- [ ] Vercel Cronを使用して1日1回実行する設定を追加
- [ ] または、手動実行のドキュメントを作成

## Phase 3: `/complete`エンドポイントの改善

### 3.1 エラーハンドリングの強化
- [ ] `backend/api/index.ts`の`/complete`エンドポイントを修正
- [ ] 自動同期が失敗した場合、既存のデータを返すように変更
- [ ] エラーログを詳細に出力

### 3.2 タイムアウト処理の追加
- [ ] 自動同期に5秒のタイムアウトを設定
- [ ] タイムアウトした場合、既存のデータを返す
- [ ] タイムアウトログを出力

### 3.3 ローカル環境でテスト
- [ ] AA5564で`/complete`エンドポイントをテスト
- [ ] コメントデータが正しく返されることを確認
- [ ] エラーケース（タイムアウト、APIエラー）をテスト

## Phase 4: 本番環境へのデプロイと確認

### 4.1 Vercelにデプロイ
- [ ] `backend/api/index.ts`の変更をコミット
- [ ] Vercelに自動デプロイ
- [ ] デプロイ完了を確認

### 4.2 本番環境でAA5564を確認
- [ ] https://property-site-frontend-kappa.vercel.app/public/properties/AA5564 にアクセス
- [ ] 「お気に入り文言」が表示されることを確認
- [ ] 「オススメコメント」が表示されることを確認
- [ ] 「内覧前コメント」が表示されることを確認

### 4.3 他の物件も確認
- [ ] 複数の物件でコメントが表示されることを確認
- [ ] エラーが発生していないか確認

## Phase 5: フロントエンドの改善（オプション）

### 5.1 ローディング表示の追加
- [ ] `frontend/src/pages/PublicPropertyDetailPage.tsx`を修正
- [ ] コメントデータ取得中はローディング表示
- [ ] 取得完了後にコメントを表示

### 5.2 エラーメッセージの表示
- [ ] コメントデータが取得できない場合、エラーメッセージを表示
- [ ] ユーザーに分かりやすいメッセージを表示

## 完了条件

- [x] AA5564のコメントデータが`property_details`テーブルに保存されている
- [ ] 本番環境でAA5564の物件詳細ページにコメントが表示される
- [ ] 他の物件でもコメントが表示される
- [ ] エラーハンドリングが適切に実装されている
- [ ] Vercelログにエラーが出力されていない

## 注意事項

- Google Sheets APIクォータ制限: 1分あたり60リクエスト
- Vercelの実行時間制限: 10秒（Hobby plan）
- 売主リスト関連のファイルは変更しない（システム隔離ルール）
