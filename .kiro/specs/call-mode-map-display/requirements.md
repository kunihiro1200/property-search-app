# 通話モードページ地図表示機能 - 要件定義

## 1. 概要

通話モードページにおいて、物件情報セクションと売主情報セクションの間に地図を表示する機能を追加します。これにより、オペレーターが物件の位置を視覚的に確認しながら売主と通話できるようになります。

## 2. 背景と目的

### 背景
- 現在、通話モードページでは物件の住所はテキストで表示されているが、地図上での位置確認ができない
- 売主との通話中に物件の位置を素早く確認したいニーズがある
- 公開物件サイトには既に地図表示機能が実装されている

### 目的
- 通話中に物件の位置を視覚的に確認できるようにする
- 物件周辺の環境や立地を把握しやすくする
- オペレーターの業務効率を向上させる

## 3. ユーザーストーリー

### US-1: 物件位置の視覚的確認
**As** オペレーター  
**I want to** 通話モードページで物件の位置を地図上で確認したい  
**So that** 売主との通話中に物件の立地を素早く把握できる

**受け入れ基準:**
- 物件情報セクションと売主情報セクションの間に地図が表示される
- 地図上に物件の位置がピンで表示される
- 物件住所（property_address）が設定されている場合のみ地図が表示される
- 物件住所が未設定の場合は地図を表示しない

### US-2: 地図の基本操作
**As** オペレーター  
**I want to** 地図をズームイン/ズームアウトしたい  
**So that** 物件周辺の詳細や広域の環境を確認できる

**受け入れ基準:**
- 地図のズーム操作ができる
- 地図のドラッグ操作ができる
- デフォルトのズームレベルは物件周辺が見やすい程度（ズームレベル15程度）

### US-3: 地図の表示サイズ
**As** オペレーター  
**I want to** 地図が適切なサイズで表示されてほしい  
**So that** 物件情報と売主情報の両方を見やすく確認できる

**受け入れ基準:**
- 地図の高さは400pxに固定
- 地図の幅は画面幅いっぱい（コンテナの幅に合わせる）
- レスポンシブデザインに対応（モバイルでも見やすい）

## 4. 機能要件

### FR-1: 地図表示位置
- 物件情報セクション（📍 物件情報）の直後に地図を表示
- 地図の後に売主情報セクション（👤 売主情報）を表示

### FR-2: 地図の表示条件
- `property_address`（物件住所）が存在する場合のみ地図を表示
- `property_address`が空またはnullの場合は地図を表示しない
- 地図が表示されない場合、エラーメッセージは表示しない（単に非表示）

### FR-3: 地図の実装方式
- Google Maps APIを使用（公開物件サイトと同じ実装）
- Google Maps JavaScript APIを使用
- APIキーは既存の環境変数を使用

### FR-4: 地図の表示内容
- 物件住所をジオコーディングして座標を取得
- 地図上に赤いピンマーカーを表示
- ピンをクリックしても特別な動作はしない（情報ウィンドウは不要）

### FR-5: 地図のスタイル
- 高さ: 400px（固定）
- 幅: 100%（コンテナ幅に合わせる）
- 角丸: 8px（他のPaperコンポーネントと統一）
- 影: Material-UIのPaperコンポーネントと同じ

### FR-6: エラーハンドリング
- ジオコーディングに失敗した場合、地図を表示しない
- Google Maps APIの読み込みに失敗した場合、地図を表示しない
- エラーメッセージは表示しない（ユーザー体験を損なわないため）

## 5. 非機能要件

### NFR-1: パフォーマンス
- 地図の読み込みは非同期で行う
- 地図の読み込み中は他のセクションの表示を妨げない
- 地図の読み込みに3秒以上かかる場合はタイムアウト

### NFR-2: 互換性
- 既存の通話モードページの機能に影響を与えない
- 既存のスタイルやレイアウトを維持
- 公開物件サイトの地図実装と同じコンポーネントを再利用

### NFR-3: 保守性
- 地図表示ロジックは独立したコンポーネントとして実装
- 公開物件サイトの地図コンポーネントを参考にする
- コードの重複を避ける

## 6. 制約事項

### 技術的制約
- Google Maps APIの利用制限に準拠
- 既存のAPIキーを使用（新規取得不要）
- 既存のプロジェクト構造を変更しない

### ビジネス的制約
- 公開物件サイトの地図機能を壊さない
- 売主リストの他の機能に影響を与えない
- 通話モードページの既存機能を維持

## 7. 除外事項

以下の機能は今回のスコープに含まれません：

- 売主住所の地図表示（物件住所のみ）
- 複数物件の同時表示
- ルート検索機能
- ストリートビュー表示
- 地図の印刷機能
- 地図のスクリーンショット機能
- カスタムマーカーアイコン（デフォルトの赤ピンを使用）

## 8. 参考情報

### 既存の地図実装
- 公開物件サイト: `frontend/src/pages/PublicPropertyDetailPage.tsx`
- 地図コンポーネント: 公開物件サイトで使用されているGoogle Maps実装を参考

### 関連ファイル
- 通話モードページ: `frontend/src/pages/CallModePage.tsx`
- 物件情報セクション: 行2610-2863
- 売主情報セクション: 行2864-3064

## 9. 成功基準

以下の条件を満たした場合、この機能は成功とみなされます：

1. 物件住所が設定されている売主の通話モードページで地図が表示される
2. 地図上に物件の位置が正確にピン表示される
3. 地図のズーム・ドラッグ操作が正常に動作する
4. 既存の通話モードページの機能が全て正常に動作する
5. 公開物件サイトの地図機能が正常に動作する（影響なし）
6. モバイル端末でも地図が見やすく表示される

## 10. リスクと対策

### リスク1: Google Maps APIの読み込み失敗
**対策:** エラーハンドリングを実装し、地図が表示されなくても他の機能は正常に動作するようにする

### リスク2: ジオコーディングの精度
**対策:** 物件住所が不正確な場合でも、可能な限り近い位置を表示する

### リスク3: パフォーマンスへの影響
**対策:** 地図の読み込みを非同期化し、他のセクションの表示を妨げないようにする

---

**作成日:** 2026年2月4日  
**作成者:** Kiro AI Assistant  
**ステータス:** レビュー待ち
