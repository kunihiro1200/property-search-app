# 通話モードページ地図表示機能

## 概要

通話モードページに物件位置を地図上に表示する機能を追加しました。

## 機能

- 物件住所からジオコーディングAPIで座標を取得
- Google Mapsで物件位置を表示
- 物件位置にピンを表示
- 物件住所が未設定の場合は地図を表示しない

## 使用場所

- 通話モードページ（CallModePage）
  - 物件情報セクションと売主情報セクションの間に表示

## 実装ファイル

### バックエンド

- `backend/src/routes/geocoding.ts` - ジオコーディングAPIエンドポイント
  - Google Geocoding APIを使用して住所から座標を取得
  - タイムアウト: 5秒
  - エラーハンドリング: 失敗時は500エラーを返す

### フロントエンド

- `frontend/src/components/PropertyMapSection.tsx` - 地図表示コンポーネント
  - ジオコーディングAPIを呼び出して座標を取得
  - Google Mapsで地図を表示
  - 物件位置にピンを表示
  - ローディング状態を管理

- `frontend/src/pages/CallModePage.tsx` - 通話モードページ
  - PropertyMapSectionコンポーネントを物件情報セクションと売主情報セクションの間に配置

## 使用方法

### 1. 環境変数の設定

`.env.local`ファイルに以下の環境変数を設定してください：

```
VITE_GOOGLE_MAPS_API_KEY=your_api_key_here
```

### 2. バックエンドサーバーの起動

```bash
cd backend
npm run dev
```

### 3. フロントエンドサーバーの起動

```bash
cd frontend
npm run dev
```

### 4. 通話モードページを開く

物件住所が設定されている売主を選択すると、物件情報セクションの下に地図が表示されます。

## テスト

テストガイドは`.kiro/specs/call-mode-map-display/test-guide.md`を参照してください。

## トラブルシューティング

### 地図が表示されない

**原因1**: Google Maps APIキーが設定されていない

**解決策**:
1. `.env.local`ファイルを確認
2. `VITE_GOOGLE_MAPS_API_KEY`が設定されているか確認
3. 設定されていない場合は、APIキーを追加
4. フロントエンドサーバーを再起動

---

**原因2**: ジオコーディングAPIが失敗している

**解決策**:
1. 開発者ツールのコンソールを開く
2. エラーメッセージを確認
3. バックエンドサーバーのログを確認
4. Google Geocoding APIのクォータを確認

---

**原因3**: 物件住所が無効

**解決策**:
1. 物件住所が正しく設定されているか確認
2. 物件住所が日本の住所形式であるか確認
3. 物件住所に特殊文字が含まれていないか確認

### 地図の読み込みが遅い

**原因**: ネットワークが遅い、またはGoogle Maps APIのレスポンスが遅い

**解決策**:
1. ネットワーク接続を確認
2. 開発者ツールのNetworkタブでリクエストを確認
3. タイムアウト設定を確認（現在5秒）

### ピンが正しい位置に表示されない

**原因**: ジオコーディングの結果が不正確

**解決策**:
1. 物件住所が正確であるか確認
2. Google Geocoding APIのレスポンスを確認
3. 必要に応じて、物件住所を修正

## 技術仕様

### ジオコーディングAPI

- **エンドポイント**: `/api/geocoding`
- **メソッド**: GET
- **パラメータ**: `address` (string)
- **レスポンス**: `{ lat: number, lng: number }`
- **タイムアウト**: 5秒
- **エラーハンドリング**: 失敗時は500エラーを返す

### 地図表示

- **地図ライブラリ**: Google Maps JavaScript API
- **地図コンテナサイズ**: 幅100%, 高さ400px
- **デフォルトズームレベル**: 15（街区レベル）
- **地図オプション**:
  - ズームコントロール: 表示
  - ストリートビューコントロール: 非表示
  - 地図タイプコントロール: 非表示
  - フルスクリーンコントロール: 表示
  - クリック可能なアイコン: 無効

### パフォーマンス

- **地図の読み込み時間**: 3秒以内（目標）
- **ジオコーディングAPIのタイムアウト**: 5秒
- **ローディングインジケーター**: 表示

## 今後の改善案

- [ ] 地図の読み込み時間を短縮（キャッシュの導入）
- [ ] ピンのカスタマイズ（色、アイコン）
- [ ] 情報ウィンドウの追加（物件情報の表示）
- [ ] 複数物件の表示（同じ売主が複数物件を持つ場合）
- [ ] 地図の保存機能（スクリーンショット）

---

**作成日:** 2026年2月4日  
**作成者:** Kiro AI Assistant  
**バージョン:** 1.0.0
