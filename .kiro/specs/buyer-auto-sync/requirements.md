# 買主自動同期機能 - 要件定義

## 概要

買主6666のデータがスプレッドシートとデータベースで異なる問題を解決するため、買主の自動同期機能を実装します。

## 背景

### 問題の発見
- **買主6666のデータ不一致**:
  - スプレッドシート: 内覧日=2025/12/27, 時間=11:15:00, 後続担当=I, 最新状況=D:配信・追客不要案件
  - データベース（修正前）: 内覧日=2025-02-05, 時間=14:00, 後続担当=K, 最新状況=内覧予定
  - 最終同期: 2025-02-04 08:09（約18時間前）

### 根本原因
1. **買主の自動同期が実装されていない** - `EnhancedAutoSyncService`は売主のみを同期
2. カラムマッピングは正しい（`buyer-column-mapping.json`の`★最新状況\n`に改行文字が含まれることを確認）

## ユーザーストーリー

### US-1: 買主データの自動同期
**As a** システム管理者  
**I want** 買主データがスプレッドシートからデータベースに自動的に同期される  
**So that** 手動で同期する必要がなく、常に最新のデータが表示される

**受け入れ基準**:
- [ ] 5分ごとに買主データが自動同期される
- [ ] 新規買主が自動的に追加される
- [ ] 既存買主のデータが自動的に更新される
- [ ] 同期エラーが発生した場合、ログに記録される

### US-2: 買主6666のデータ修正
**As a** ユーザー  
**I want** 買主6666のデータが正しく表示される  
**So that** 正確な情報を確認できる

**受け入れ基準**:
- [ ] 内覧日が2025-12-27と表示される
- [ ] 時間が11:15:00と表示される
- [ ] 後続担当がIと表示される
- [ ] 最新状況が「D:配信・追客不要案件」と表示される

## 技術要件

### TR-1: EnhancedAutoSyncServiceへの買主同期追加
- 買主用のGoogle Sheetsクライアント初期化メソッド（`initializeBuyer()`）
- 買主スプレッドシートデータ取得メソッド（`getBuyerSpreadsheetData()`）
- 買主番号取得メソッド（`getAllDbBuyerNumbers()`）
- 不足買主検出メソッド（`detectMissingBuyers()`）
- 更新買主検出メソッド（`detectUpdatedBuyers()`）
- 買主同期メソッド（`syncMissingBuyers()`, `syncUpdatedBuyers()`）
- 単一買主同期メソッド（`syncSingleBuyer()`, `updateSingleBuyer()`）
- 完全同期メソッド（`syncBuyers()`）

### TR-2: runFullSync()への買主同期追加
- Phase 5として買主同期を追加
- 5分ごとの自動同期で実行される

### TR-3: UPSERT制約エラーの解決
- `syncSingleBuyer()`メソッドでUPSERTの代わりにINSERT/UPDATEを使用
- 既存の買主を確認してから挿入または更新

### TR-4: 日付範囲エラーの対応
- `formatBuyerDate()`メソッドに日付範囲チェックとエラーハンドリングを追加
- 異常なExcelシリアル値（45000番台）をスキップ

## 環境変数

### 買主スプレッドシート設定
- `GOOGLE_SHEETS_BUYER_SPREADSHEET_ID`: 買主スプレッドシートID（デフォルト: `PROPERTY_LISTING_SPREADSHEET_ID`と同じ）
- `GOOGLE_SHEETS_BUYER_SHEET_NAME`: 買主シート名（デフォルト: `買主リスト`）

## 制約事項

### データ品質
- 一部の買主（14件）は異常なExcelシリアル値を持っており、同期エラーが発生する
- これらの買主のスプレッドシートデータを手動で修正する必要がある

### パフォーマンス
- 買主スプレッドシートデータは60分間キャッシュされる（Google Sheets APIクォータ対策）
- 手動同期時はキャッシュが自動的にクリアされる

## 非機能要件

### NFR-1: パフォーマンス
- 買主同期は5分以内に完了する必要がある
- Google Sheets APIクォータを超えないようにキャッシュを使用する

### NFR-2: 信頼性
- 同期エラーが発生しても、次回の同期で再試行される
- エラーログが記録され、問題の特定が容易になる

### NFR-3: 保守性
- コードは読みやすく、理解しやすい
- ドキュメントが充実している

## 成功基準

1. 買主6666のデータが正しく同期される
2. 5分ごとの自動同期が正常に動作する
3. 新規買主が自動的に追加される
4. 既存買主のデータが自動的に更新される
5. 同期エラーが14件以下（異常なExcelシリアル値を持つ買主）

## リスクと対策

### リスク1: Google Sheets APIクォータ超過
**対策**: 買主スプレッドシートデータを60分間キャッシュする

### リスク2: 異常なExcelシリアル値
**対策**: `formatBuyerDate()`メソッドで日付範囲チェックを実装し、異常な値をスキップする

### リスク3: UPSERT制約エラー
**対策**: UPSERTの代わりにINSERT/UPDATEを使用する

## 参考資料

- `.kiro/steering/buyer-table-column-definition.md` - 買主テーブルのカラム定義
- `backend/src/config/buyer-column-mapping.json` - 買主カラムマッピング定義
- `backend/src/services/BuyerColumnMapper.ts` - 買主カラムマッピング実装
- `backend/src/services/BuyerService.ts` - 買主サービス実装

## 更新履歴

- 2026-02-05: 初版作成
