# 売主詳細画面に近隣買主リストを表示

## 概要
売主詳細画面（通話モードページ）に、物件住所の半径3KM以内のエリアに該当する買主リストを表示する機能を追加します。

## 背景
- 売主の物件住所に基づいて、近隣エリアに興味がある買主を表示したい
- 買主の希望エリア（★エリア）と物件のエリアをマッチングする
- エリアの定義はGoogleスプレッドシート「シート6」に記載されている

## データソース

### エリアマップスプレッドシート
- **スプレッドシートID**: `13z-giNycrxKQJNuWQNsb99XvY2ijkBgwvTRcrelHbaQ`
- **シート名**: `シート6`
- **内容**: エリア番号とそのエリアの中心座標、半径3KMの範囲

### 買主テーブル
- **テーブル**: `buyers`
- **カラム**: `distribution_areas`（★エリアの番号、カンマ区切り）
- **例**: `"1,2,3"` → エリア1、2、3に興味がある買主

### 売主テーブル
- **テーブル**: `sellers`
- **カラム**: `property_address`（物件住所）
- **例**: `"大分市中央町1-1-1"`

## 要件

### 1. エリアマップデータの取得
- [ ] スプレッドシート「シート6」からエリアマップデータを取得
- [ ] エリア番号、中心座標（緯度・経度）、半径を取得
- [ ] データをキャッシュして効率化

### 2. 物件住所からエリア番号を特定
- [ ] 売主の物件住所（`property_address`）から座標を取得
- [ ] 座標がどのエリア（半径3KM以内）に該当するか判定
- [ ] 該当するエリア番号のリストを取得

### 3. 該当エリアの買主を取得
- [ ] 買主テーブルから`distribution_areas`に該当エリア番号が含まれる買主を取得
- [ ] 買主リストをテーブル形式で表示

### 4. UI表示
- [ ] 売主詳細画面に「近隣買主リスト」セクションを追加
- [ ] 買主リストをテーブル形式で表示
  - 買主番号
  - 氏名
  - 電話番号
  - 希望エリア（★エリア）
  - 最新状況
  - 内覧日（最新）
- [ ] 買主番号をクリックすると買主詳細ページに遷移

## 受け入れ基準

### AC1: エリアマップデータの取得
- [ ] スプレッドシート「シート6」からエリアマップデータを取得できる
- [ ] エリア番号、中心座標、半径が正しく取得できる
- [ ] データがキャッシュされ、2回目以降は高速に取得できる

### AC2: 物件住所からエリア番号を特定
- [ ] 売主の物件住所から座標を取得できる
- [ ] 座標が半径3KM以内のエリアに該当するか判定できる
- [ ] 該当するエリア番号のリストが取得できる

### AC3: 該当エリアの買主を取得
- [ ] 買主テーブルから該当エリアの買主を取得できる
- [ ] 買主の`distribution_areas`に該当エリア番号が含まれる買主のみが取得される
- [ ] 買主リストが正しく表示される

### AC4: UI表示
- [ ] 売主詳細画面に「近隣買主リスト」セクションが表示される
- [ ] 買主リストがテーブル形式で表示される
- [ ] 買主番号をクリックすると買主詳細ページに遷移できる
- [ ] 該当する買主がいない場合は「該当する買主はいません」と表示される

## 技術的な詳細

### バックエンド

#### 1. エリアマップサービス
- **ファイル**: `backend/src/services/AreaMapService.ts`（新規作成）
- **メソッド**:
  - `getAreaMapData()`: スプレッドシート「シート6」からエリアマップデータを取得
  - `getAreasForCoordinates(lat, lng)`: 座標が該当するエリア番号のリストを取得
  - `calculateDistance(lat1, lng1, lat2, lng2)`: 2点間の距離を計算（ヒュベニの公式）

#### 2. 売主APIエンドポイント
- **ファイル**: `backend/src/routes/sellers.ts`
- **エンドポイント**: `GET /api/sellers/:id/nearby-buyers`
- **処理**:
  1. 売主の物件住所から座標を取得
  2. 座標が該当するエリア番号を取得
  3. 該当エリアの買主を取得
  4. 買主リストを返す

#### 3. 買主サービス
- **ファイル**: `backend/src/services/BuyerService.ts`
- **メソッド**: `getBuyersByAreas(areaNumbers: number[])`: 該当エリアの買主を取得

### フロントエンド

#### 1. 近隣買主リストコンポーネント
- **ファイル**: `frontend/src/components/NearbyBuyersList.tsx`（新規作成）
- **Props**:
  - `sellerId: string` - 売主ID
- **表示内容**:
  - 買主リストテーブル
  - ローディング状態
  - エラー表示

#### 2. 売主詳細画面への統合
- **ファイル**: `frontend/src/pages/CallModePage.tsx`
- **追加箇所**: 物件情報セクションの下に「近隣買主リスト」セクションを追加

## データ構造

### エリアマップデータ（スプレッドシート「シート6」）
```typescript
interface AreaMapData {
  areaNumber: number;      // エリア番号
  centerLat: number;       // 中心座標（緯度）
  centerLng: number;       // 中心座標（経度）
  radius: number;          // 半径（メートル）
  areaName?: string;       // エリア名（オプション）
}
```

### 買主データ（`buyers`テーブル）
```typescript
interface Buyer {
  buyer_number: string;           // 買主番号
  name: string;                   // 氏名
  phone: string;                  // 電話番号
  distribution_areas: string;     // 希望エリア（カンマ区切り）例: "1,2,3"
  latest_status: string;          // 最新状況
  latest_viewing_date: string;    // 内覧日（最新）
}
```

### APIレスポンス（`GET /api/sellers/:id/nearby-buyers`）
```typescript
interface NearbyBuyersResponse {
  buyers: Buyer[];
  matchedAreas: number[];  // 該当したエリア番号のリスト
  propertyAddress: string; // 物件住所
}
```

## 実装の優先順位

### Phase 1: バックエンド実装
1. エリアマップサービスの作成
2. 売主APIエンドポイントの追加
3. 買主サービスのメソッド追加

### Phase 2: フロントエンド実装
1. 近隣買主リストコンポーネントの作成
2. 売主詳細画面への統合

### Phase 3: テストと調整
1. エリア判定のテスト
2. 買主リスト表示のテスト
3. パフォーマンスの最適化

## 注意事項

### システム隔離ルール
- この機能は**売主リスト（Seller Management）システム**と**買主リスト（Buyer Management）システム**の両方に関連します
- 売主詳細画面に買主データを表示しますが、買主データの変更は行いません（読み取り専用）

### パフォーマンス
- エリアマップデータはキャッシュして効率化
- 座標の取得にはGoogle Maps APIを使用（既存の実装を流用）
- 買主リストの取得はページネーションを考慮（将来的に）

### エラーハンドリング
- 物件住所が空の場合は「物件住所が設定されていません」と表示
- 座標が取得できない場合は「座標を取得できませんでした」と表示
- 該当する買主がいない場合は「該当する買主はいません」と表示

## 関連ドキュメント
- `.kiro/steering/system-isolation-rule.md` - システム隔離ルール
- `.kiro/steering/seller-table-column-definition.md` - 売主テーブルのカラム定義
- `.kiro/steering/buyer-table-column-definition.md` - 買主テーブルのカラム定義
- `.kiro/steering/buyer-property-card-sync-rule.md` - 買主詳細ページの物件詳細カード同期ルール（参考）
