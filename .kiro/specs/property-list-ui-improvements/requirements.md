# 物件リストUI改善 - 要件定義

## 1. 概要

物件リストページのUIを改善し、ユーザビリティを向上させる。

**対象システム**: 物件リスト（Property Management）のみ
**影響範囲**: フロントエンドのみ（バックエンドは値下げ通知ロジックのみ変更）

## 2. 背景

### 現在の問題点

1. **ヘッダーボタンの重複**
   - 「公開物件サイト」と「一般向け公開サイト」が同じURLを開く
   - ユーザーが混乱する

2. **サイドバーカテゴリーの順序**
   - 「値下げ未完了」が優先順位0で最上位に表示される
   - 「すべて」の下に配置する方が自然

3. **値下げ通知の送信タイミング**
   - 事前に値下げ予約をしていた場合、その日の9時（東京時間）にChat送信するようにコミットしていた
   - しかし、実際には9時にChat送信されていない（バグ）
   - 値下げ予約の日時が来ても通知が送信されない
   - **具体例**: 物件BB14で「02/14 9:00 テストです」と予約したが、9時になってもChat送信されていない

## 3. ユーザーストーリー

### 3.1 即値下げボタンの追加

**As a** 物件リスト管理者  
**I want** 「予約値下げ」の上に「即値下げ」ボタンを設置し、クリックするとGoogle Chatに遷移できる  
**So that** すぐに値下げ通知を送信できる

**受け入れ基準**:
- [ ] 「予約値下げ」セクションの上に「即値下げ」ボタンが表示される
- [ ] 「即値下げ」ボタンをクリックすると、「Chat送信」ボタンが現れる
- [ ] 「Chat送信」ボタンをクリックすると、Google Chat URLに遷移する
- [ ] Google Chat URL: `https://chat.googleapis.com/v1/spaces/AAAAw9wyS-o/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=t6SJmZ8af-yyB38DZzAqGOKYI-DnIl6wYtVo-Lyskuk`
- [ ] 既存の「予約値下げ」機能は変更されない

### 3.2 ヘッダーボタンの整理

### 3.2 ヘッダーボタンの整理

**As a** 物件リスト管理者  
**I want** ヘッダーに「一般向け公開サイト」と「管理者向け公開サイト」のみを表示  
**So that** 重複したボタンがなく、シンプルなUIになる

**受け入れ基準**:
- [ ] 「公開物件サイト」ボタンが削除されている
- [ ] 「一般向け公開サイト」ボタンが表示されている
- [ ] 「管理者向け公開サイト」ボタンが表示されている
- [ ] 両方のボタンが正しいURLを開く

### 3.3 サイドバーカテゴリーの順序変更

### 3.3 サイドバーカテゴリーの順序変更

**As a** 物件リスト管理者  
**I want** サイドバーカテゴリーで「すべて」が最上位に表示される  
**So that** 全物件を確認しやすくなる

**受け入れ基準**:
- [ ] 「すべて」が最上位に表示される
- [ ] 「値下げ未完了」が「すべて」の下に表示される
- [ ] 他のカテゴリーの順序は変更されない
- [ ] カテゴリーのカウント数が正しく表示される

### 3.4 値下げ通知の送信タイミング修正

**As a** 物件リスト管理者  
**I want** 値下げ予約をした場合、その日の9時（東京時間）にChat通知が自動送信される  
**So that** 予約した通りに値下げ通知が送信される

**受け入れ基準**:
- [ ] 値下げ予約日が本日（東京時間）で、現在時刻が9時以降の場合、通知が送信される
- [ ] 値下げ予約日が本日（東京時間）で、現在時刻が9時前の場合、通知が送信されない（9時まで待つ）
- [ ] 値下げ予約日が過去の場合、すぐに通知が送信される（遅延通知）
- [ ] 値下げ予約日が未来の場合、通知が送信されない（予約日まで待つ）
- [ ] 通知送信後、「値下げ未完了」リストから削除される

## 4. 技術的制約

### 4.1 システム隔離ルール

**絶対に守るべきルール**:
- 物件リスト（Property Management）専用のファイルのみを変更する
- 公開物件サイト（Public Property Site）には絶対に影響を与えない

**変更対象ファイル**:
- ✅ `frontend/src/components/PublicSiteButtons.tsx` - ヘッダーボタン
- ✅ `frontend/src/components/PropertySidebarStatus.tsx` - サイドバーカテゴリー
- ✅ `backend/src/services/ChatNotificationService.ts` - 値下げ通知ロジック（推測）

**変更禁止ファイル**:
- ❌ `backend/api/index.ts` - 公開物件サイト専用
- ❌ `backend/api/src/services/PropertyListingService.ts` - 公開物件サイト専用
- ❌ `frontend/src/pages/PublicPropertyListPage.tsx` - 公開物件サイト専用
- ❌ `frontend/src/pages/PublicPropertyDetailPage.tsx` - 公開物件サイト専用

### 4.2 後方互換性

**絶対に守るべきルール**:
- 既存のURLは変更しない
- 既存のAPIエンドポイントは変更しない
- 既存の機能は削除しない

## 5. 非機能要件

### 5.1 パフォーマンス

- サイドバーカテゴリーの表示速度は変更前と同等
- ヘッダーボタンの表示速度は変更前と同等

### 5.2 互換性

- 既存のブックマークは動作し続ける
- 既存の外部リンクは動作し続ける

### 5.3 セキュリティ

- 認証・認可ロジックは変更しない
- 公開物件サイトのセキュリティには影響を与えない

## 6. 実装の優先順位

1. **高**: 即値下げボタンの追加（3.1）
2. **高**: ヘッダーボタンの整理（3.2）
3. **高**: サイドバーカテゴリーの順序変更（3.3）
4. **中**: 値下げ通知の送信タイミング修正（3.4）

## 7. テスト計画

### 7.1 即値下げボタンのテスト

- [ ] 「即値下げ」ボタンが「予約値下げ」の上に表示されることを確認
- [ ] 「即値下げ」ボタンをクリックして、「Chat送信」ボタンが現れることを確認
- [ ] 「Chat送信」ボタンをクリックして、Google Chat URLに遷移することを確認
- [ ] Google Chat URLが正しいことを確認
- [ ] 既存の「予約値下げ」機能が正常に動作することを確認

### 7.2 ヘッダーボタンのテスト

### 7.2 ヘッダーボタンのテスト

- [ ] 「一般向け公開サイト」ボタンをクリックして、正しいURLが開くことを確認
- [ ] 「管理者向け公開サイト」ボタンをクリックして、正しいURLが開くことを確認
- [ ] 「公開物件サイト」ボタンが表示されないことを確認

### 7.3 サイドバーカテゴリーのテスト

### 7.3 サイドバーカテゴリーのテスト

- [ ] 「すべて」が最上位に表示されることを確認
- [ ] 「値下げ未完了」が「すべて」の下に表示されることを確認
- [ ] 各カテゴリーのカウント数が正しいことを確認
- [ ] カテゴリーをクリックして、フィルタリングが正しく動作することを確認

### 7.4 値下げ通知のテスト

- [ ] 値下げ予約日が本日（東京時間）で、現在時刻が9時前の場合、通知が送信されないことを確認
- [ ] 値下げ予約日が本日（東京時間）で、現在時刻が9時以降の場合、通知が送信されることを確認
- [ ] 値下げ予約日が過去の場合、すぐに通知が送信されることを確認（遅延通知）
- [ ] 値下げ予約日が未来の場合、通知が送信されないことを確認
- [ ] 通知送信後、「値下げ未完了」リストから削除されることを確認
- [ ] 9時ちょうどに通知が送信されることを確認（Cronジョブのタイミング）

## 8. リスク管理

### 8.1 高リスク

**リスク**: 公開物件サイトに影響を与える  
**対策**: システム隔離ルールを厳守し、物件リスト専用のファイルのみを変更する  
**検証**: 公開物件サイトの動作確認を実施

### 8.2 中リスク

**リスク**: 既存のURLが動作しなくなる  
**対策**: 後方互換性ルールを厳守し、URLは変更しない  
**検証**: 既存のブックマークと外部リンクの動作確認を実施

### 8.3 低リスク

**リスク**: サイドバーカテゴリーの順序変更により、ユーザーが混乱する  
**対策**: 変更内容をユーザーに事前に通知する  
**検証**: ユーザーフィードバックを収集

## 9. 成功基準

## 9. 成功基準

- [ ] 「即値下げ」ボタンが表示され、Google Chatに遷移できる
- [ ] ヘッダーに「公開物件サイト」ボタンが表示されない
- [ ] サイドバーカテゴリーで「すべて」が最上位に表示される
- [ ] 値下げ予約日の9時（東京時間）に通知が自動送信される
- [ ] 公開物件サイトに影響がない
- [ ] 既存のURLが動作し続ける
- [ ] パフォーマンスが変更前と同等

## 10. 参考資料

- `.kiro/steering/system-isolation-rule.md` - システム隔離ルール
- `.kiro/steering/backward-compatibility-rule.md` - 後方互換性ルール
- `frontend/src/components/PublicSiteButtons.tsx` - ヘッダーボタンの実装
- `frontend/src/components/PropertySidebarStatus.tsx` - サイドバーカテゴリーの実装

---

**作成日**: 2026年2月14日  
**作成者**: Kiro AI  
**ステータス**: レビュー待ち
