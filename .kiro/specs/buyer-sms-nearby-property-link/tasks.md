# Implementation Plan: 買主SMS近隣物件リンク追加機能

## Overview

買主詳細ページのSMS送信機能において、SMS本文に所在地が含まれる場合、自動的に近隣物件へのリンクを追加する機能を実装します。実装は段階的に進め、各フェーズで動作確認を行います。

## Tasks

- [x] 1. フロントエンド実装（近隣物件リンク挿入機能）
  - [x] 1.1 insertNearbyPropertyLink関数を実装
    - `BuyerDetailPage.tsx`に`insertNearbyPropertyLink()`関数を追加
    - 所在地プレースホルダーの検出ロジック実装
    - 買主に紐づいた物件の確認ロジック実装
    - 短縮URL生成ロジック実装（`https://ifoo.jp/p/{物件番号}`）
    - 挿入位置の検索と挿入ロジック実装（「お気軽にお問合せください」の直前、または末尾）
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 3.4_

  - [x] 1.2 handleSmsTemplateSelect関数を修正
    - `replacePlaceholders()`実行後に`insertNearbyPropertyLink()`を呼び出し
    - 近隣物件リンク挿入後の本文を確認ダイアログに渡す
    - _Requirements: 5.2_

  - [x] 1.3 文字数チェック機能を実装
    - 近隣物件リンク挿入後の文字数をカウント
    - 670文字を超える場合は警告メッセージを表示
    - 警告が出ても確認ダイアログは表示（ユーザーが判断）
    - _Requirements: 4.1_

  - [ ]* 1.4 フロントエンド単体テストを実装
    - 所在地プレースホルダーあり + 物件あり → リンク挿入
    - 所在地プレースホルダーなし + 物件あり → リンク挿入なし
    - 所在地プレースホルダーあり + 物件なし → リンク挿入なし
    - 「お気軽にお問合せください」あり → マーカー直前に挿入
    - 「お気軽にお問合せください」なし → 末尾に挿入
    - 670文字ちょうど → 警告なし
    - 671文字 → 警告あり
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.1, 3.2, 3.4, 4.1_

  - [ ]* 1.5 フロントエンドプロパティベーステストを実装
    - **Property 1: 近隣物件リンク挿入の条件判定**
    - **Validates: Requirements 1.1, 1.3, 1.4**
    - **Property 2: 短縮URL生成の形式**
    - **Validates: Requirements 2.1, 2.2, 2.3, 2.5**
    - **Property 3: 挿入位置の制御**
    - **Validates: Requirements 3.1, 3.2, 3.4**
    - **Property 4: リンクフォーマット**
    - **Validates: Requirements 1.2, 3.3**
    - **Property 5: 文字数制限チェック**
    - **Validates: Requirements 4.1**
    - **Property 6: プレースホルダー置換後の挿入**
    - **Validates: Requirements 5.2**
    - **Property 8: プレビュー表示**
    - **Validates: Requirements 6.1, 6.3**
    - fast-checkライブラリを使用
    - 各プロパティテストは最低100回反復実行
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.5, 3.1, 3.2, 3.3, 3.4, 4.1, 5.2, 6.1, 6.3_

- [x] 2. Checkpoint - フロントエンド動作確認
  - ローカル環境でフロントエンドを起動
  - 買主詳細ページでSMSテンプレートを選択
  - プレビューに近隣物件リンクが表示されることを確認
  - 文字数カウントが正しく動作することを確認
  - 全てのテストが通ることを確認
  - 問題があればユーザーに報告

- [x] 3. バックエンド実装（短縮URLリダイレクト機能）
  - [x] 3.1 backend/api/redirect.tsを作成
    - Vercel Serverless Function形式で実装
    - パスパラメータから物件番号を取得
    - 物件番号のバリデーション実装（正規表現: `/^[A-Z]{2}\d{4,5}(-\d+)?$/`）
    - HTTP 301リダイレクトレスポンスを返す
    - リダイレクト先URL: `https://property-site-frontend-kappa.vercel.app/public/properties/{物件番号}`
    - キャッシュヘッダー設定（`Cache-Control: public, max-age=31536000`）
    - セキュリティヘッダー設定（`Strict-Transport-Security`）
    - エラーハンドリング実装（400, 500エラー）
    - _Requirements: 7.1, 7.2, 7.3, 8.1, 8.2, 8.3_

  - [x] 3.2 backend/vercel.jsonを更新
    - `/p/:propertyNumber`のルーティング設定を追加
    - 既存のルーティング設定を維持
    - キャッシュヘッダー設定を追加
    - セキュリティヘッダー設定を追加
    - _Requirements: 7.1_

  - [ ]* 3.3 バックエンド単体テストを実装
    - 有効な物件番号（"AA9831"） → 301リダイレクト
    - 有効な物件番号（ハイフン付き "AA13527-2"） → 301リダイレクト
    - 無効な物件番号（"INVALID"） → 400エラー
    - 物件番号なし → 400エラー
    - リダイレクト先URLの検証
    - キャッシュヘッダーの検証
    - _Requirements: 7.1, 7.2, 7.3_

  - [ ]* 3.4 バックエンドプロパティベーステストを実装
    - **Property 7: リダイレクト処理**
    - **Validates: Requirements 7.1, 7.2, 7.3**
    - fast-checkライブラリを使用
    - 有効な物件番号と無効な物件番号をランダム生成
    - 各プロパティテストは最低100回反復実行
    - _Requirements: 7.1, 7.2, 7.3_

- [x] 4. Checkpoint - バックエンド動作確認
  - ローカル環境でバックエンドを起動（`vercel dev`）
  - `/p/AA9831`にアクセスして301リダイレクトを確認
  - 無効な物件番号で400エラーを確認
  - 全てのテストが通ることを確認
  - 問題があればユーザーに報告

- [ ] 5. インフラ設定（ドメインとSSL）
  - [ ] 5.1 ifoo.jpドメインのDNSレコード設定
    - ドメインレジストラにログイン
    - Aレコードを追加（`ifoo.jp` → Vercelのエッジネットワーク）
    - AAAAレコードを追加（IPv6対応）
    - CNAMEレコードを追加（`www.ifoo.jp` → `cname.vercel-dns.com`）
    - TTLを3600秒（1時間）に設定
    - DNSレコードの伝播を確認（`dig ifoo.jp A`）
    - _Requirements: 9.1, 9.2_

  - [ ] 5.2 Vercelプロジェクトにドメインを追加
    - Vercelダッシュボードにログイン
    - プロジェクト設定 → Domains
    - `ifoo.jp`を追加
    - DNSレコードの確認（Vercel自動チェック）
    - SSL証明書の自動発行を待つ（約5-10分）
    - HTTPS通信の確認（`curl -I https://ifoo.jp`）
    - _Requirements: 9.3, 9.4_

- [ ] 6. Checkpoint - インフラ動作確認
  - `https://ifoo.jp/p/AA9831`にアクセス
  - 物件詳細ページにリダイレクトされることを確認
  - SSL証明書が有効であることを確認
  - 問題があればユーザーに報告

- [ ] 7. 統合テストとデプロイ
  - [ ] 7.1 プレビュー環境へのデプロイ
    - Gitブランチを作成（`feature/buyer-sms-nearby-property-link`）
    - フロントエンドとバックエンドの変更をコミット
    - GitHubにプッシュ
    - Vercelが自動的にプレビュー環境をデプロイ
    - プレビューURLで動作確認
    - _Requirements: 全要件_

  - [ ] 7.2 E2Eテスト実行
    - プレビュー環境で買主詳細ページを開く
    - SMSテンプレートを選択
    - プレビューに近隣物件リンクが表示されることを確認
    - 短縮URLをクリックして物件詳細ページに遷移することを確認
    - SMS送信記録が正しく保存されることを確認
    - _Requirements: 全要件_

  - [ ]* 7.3 統合テストを実装
    - フロントエンドからバックエンドまでのE2Eテスト
    - SMS本文生成 → 短縮URLリダイレクト → 物件詳細ページ表示
    - _Requirements: 全要件_

  - [ ] 7.4 本番環境へのデプロイ
    - プレビュー環境でのテストが完了したことを確認
    - mainブランチにマージ
    - Vercelが自動的に本番環境をデプロイ
    - 本番環境で動作確認
    - _Requirements: 全要件_

- [ ] 8. Final Checkpoint - 本番環境動作確認
  - 本番環境で買主詳細ページを開く
  - SMSテンプレートを選択
  - プレビューに近隣物件リンクが表示されることを確認
  - 短縮URL（`https://ifoo.jp/p/AA9831`）をクリック
  - 物件詳細ページに正しくリダイレクトされることを確認
  - SMS送信記録が正しく保存されることを確認
  - 全てのテストが通ることを確認
  - 問題があればユーザーに報告

## Notes

- タスクに`*`が付いているものはオプション（テスト関連）で、コア機能の実装を優先する場合はスキップ可能
- 各タスクは特定の要件を参照しており、トレーサビリティを確保
- チェックポイントタスクで段階的に動作確認を行い、問題を早期発見
- プロパティベーステストは各プロパティを個別のテストとして実装
- 単体テストは特定の例とエッジケースを検証
- 統合テストはE2Eフローを検証
- 既存機能への影響を最小限に抑えるため、段階的にデプロイ
