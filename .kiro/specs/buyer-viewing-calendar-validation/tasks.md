# Implementation Plan: 買主内覧ページのバリデーション機能

## Overview

買主リストの内覧ページ（BuyerViewingResultPage）に、「カレンダーで開く」ボタンをクリックする前に必須フィールドの入力を検証する機能を追加します。実装は段階的に行い、各ステップで動作確認を行います。

## Tasks

- [x] 1. ValidationServiceの実装
  - ValidationServiceクラスを作成し、必須フィールドのバリデーションロジックを実装
  - `validateRequiredFields()`メソッドを実装（内覧日、時間、内覧形態、後続担当のチェック）
  - `getValidationErrorMessage()`メソッドを実装（エラーメッセージの生成）
  - 専任物件と一般媒介物件の判定ロジックを実装
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.2, 3.4_

- [ ]* 1.1 ValidationServiceのプロパティテストを作成
  - **Property 1: 必須フィールドの完全性チェック**
  - **Validates: Requirements 1.4, 2.2, 7.1**

- [ ]* 1.2 専任物件の内覧形態必須チェックのプロパティテストを作成
  - **Property 2: 専任物件の内覧形態必須チェック**
  - **Validates: Requirements 1.2, 7.2**

- [ ]* 1.3 一般媒介物件の内覧形態必須チェックのプロパティテストを作成
  - **Property 3: 一般媒介物件の内覧形態必須チェック**
  - **Validates: Requirements 1.3, 7.2**

- [ ]* 1.4 エラーメッセージフォーマットのプロパティテストを作成
  - **Property 5: エラーメッセージのフォーマット**
  - **Validates: Requirements 3.2, 3.3, 3.4**

- [x] 2. CalendarLinkGeneratorの実装
  - CalendarLinkGeneratorクラスを作成し、既存のカレンダーリンク生成ロジックをリファクタリング
  - `generateCalendarLink()`メソッドを実装（買主データと従業員データからカレンダーURLを生成）
  - `formatDateForCalendar()`メソッドを実装（日時フォーマット）
  - 後続担当のメールアドレス取得ロジックを実装
  - srcパラメータをカレンダーURLに追加
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ]* 2.1 後続担当のカレンダーリンク生成のプロパティテストを作成
  - **Property 6: 後続担当のカレンダーリンク生成**
  - **Validates: Requirements 4.2, 4.3**

- [ ]* 2.2 カレンダーイベント情報の完全性のプロパティテストを作成
  - **Property 7: カレンダーイベント情報の完全性**
  - **Validates: Requirements 4.4, 7.4**

- [x] 3. Checkpoint - ValidationServiceとCalendarLinkGeneratorのテスト
  - ValidationServiceとCalendarLinkGeneratorの単体テストを実行
  - 全てのテストが成功することを確認
  - ユーザーに質問があれば確認

- [x] 4. BuyerViewingResultPageへのバリデーション統合
  - `handleCalendarButtonClick()`関数を作成
  - カレンダーボタンのonClickイベントを`handleCalendarButtonClick()`に変更
  - バリデーション失敗時にスナックバーで警告メッセージを表示
  - バリデーション成功時にCalendarLinkGeneratorを使用してカレンダーを開く
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1_

- [ ]* 4.1 バリデーション成功時のカレンダー開放のプロパティテストを作成
  - **Property 4: バリデーション成功時のカレンダー開放**
  - **Validates: Requirements 2.3, 4.1**

- [ ]* 4.2 バリデーション統合のユニットテストを作成
  - ボタンクリック時にバリデーションが実行されることを確認
  - バリデーション失敗時にカレンダーが開かないことを確認
  - バリデーション成功時にカレンダーが開くことを確認
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 5. 必須フィールドの視覚的インジケーター追加
  - 必須フィールドに赤枠とラベルを追加（未入力時のみ）
  - 内覧日、時間、後続担当フィールドに「*必須」ラベルを追加
  - 内覧形態フィールドは既に実装済み（条件付き必須表示）
  - CSSアニメーションを追加（フェードイン効果）
  - _Requirements: 5.1, 5.2, 5.3_

- [ ]* 5.1 UI状態管理のユニットテストを作成
  - 内覧日が空の場合にボタンが非表示になることを確認
  - 内覧日が入力されている場合にボタンが表示されることを確認
  - ボタンが常にクリック可能であることを確認
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 6. エラーハンドリングの実装
  - try-catchブロックを追加してバリデーションエラーをキャッチ
  - try-catchブロックを追加してカレンダーリンク生成エラーをキャッチ
  - 全てのエラーをconsole.error()でログに記録
  - エラー時にスナックバーでユーザーフレンドリーなメッセージを表示
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [ ]* 6.1 エラー時のシステム安定性のプロパティテストを作成
  - **Property 9: エラー時のシステム安定性**
  - **Validates: Requirements 8.2, 8.3, 8.4**

- [ ]* 6.2 エラーハンドリングのユニットテストを作成
  - バリデーションエラー時にエラーメッセージが表示されることを確認
  - カレンダーリンク生成エラー時にエラーメッセージが表示されることを確認
  - エラー時にシステムがクラッシュしないことを確認
  - _Requirements: 8.1, 8.2, 8.4_

- [ ] 7. 有効な従業員イニシャルの検証
  - 後続担当が従業員リストに存在するかチェック
  - 存在しない場合は警告メッセージを表示（カレンダーは開く）
  - srcパラメータなしでカレンダーを開く
  - _Requirements: 7.3_

- [ ]* 7.1 有効な従業員イニシャルの検証のプロパティテストを作成
  - **Property 8: 有効な従業員イニシャルの検証**
  - **Validates: Requirements 7.3**

- [ ] 8. Checkpoint - 全機能の統合テスト
  - 全てのユニットテストとプロパティテストを実行
  - ブラウザで手動テストを実行（各シナリオを確認）
  - システム隔離ルールの遵守を確認（買主リスト専用ファイルのみ変更）
  - ユーザーに質問があれば確認

- [ ] 9. ドキュメントとコメントの追加
  - ValidationServiceとCalendarLinkGeneratorにJSDocコメントを追加
  - 複雑なロジックに説明コメントを追加
  - README.mdに新機能の説明を追加（必要に応じて）
  - _Requirements: 全体_

## Notes

- タスクに`*`が付いているものはオプションで、MVPを早く完成させるためにスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントで段階的な検証を行い、問題を早期に発見します
- プロパティテストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します
- システム隔離ルールに従い、買主リスト専用のファイル（`frontend/src/pages/BuyerViewingResultPage.tsx`）のみを変更します
