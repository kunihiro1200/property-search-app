# 通話モードページ：コメント欄分離機能 - 要件定義

## 1. 概要

通話モードページの「コミュニケーション履歴」セクションと「通話メモ入力」セクションを**分離**し、それぞれ独立した役割を持たせます。

- **スプレッドシートコメント表示**（読み取り専用）：スプレッドシートの「コメント」カラムを表示
- **通話メモ入力**（編集可能）：新規コメントを入力し、スプレッドシートに追記

## 2. 背景

### 現在の問題点

1. **統一コメント欄の問題**
   - スプレッドシート → データベースの定期同期（5分ごと）が、ユーザーが入力した新規コメントを上書きしてしまう
   - ユーザーが入力したコメントが消えてしまう

2. **同期の競合**
   - データベース → スプレッドシートの即時同期（数秒以内）
   - スプレッドシート → データベースの定期同期（5分ごと）
   - 2つの同期が競合して、データが上書きされる

### 解決策

**元の分離された設計に戻す**：

1. **スプレッドシートコメント表示**（読み取り専用）
   - スプレッドシートの「コメント」カラムを表示
   - 定期同期（5分ごと）でスプレッドシート → データベースに同期
   - ユーザーは編集できない

2. **通話メモ入力**（編集可能）
   - ユーザーが新規コメントを入力
   - 保存ボタンをクリックすると、データベースに保存
   - 即時同期でデータベース → スプレッドシートに同期

## 3. 要件定義

### 3.1 機能要件

#### FR-1: スプレッドシートコメント表示（読み取り専用）

**優先度**: 高

**説明**: スプレッドシートの「コメント」カラムを読み取り専用で表示する。

**受け入れ基準**:
- [ ] 「コミュニケーション履歴」セクションに「スプレッドシートコメント」が表示される
- [ ] スプレッドシートの「コメント」カラムの内容が表示される
- [ ] 表示は読み取り専用である（編集不可）
- [ ] 定期同期（5分ごと）でスプレッドシート → データベースに同期される

---

#### FR-2: 通話メモ入力（編集可能）

**優先度**: 高

**説明**: ユーザーが新規コメントを入力し、スプレッドシートに追記する。

**受け入れ基準**:
- [ ] 「通話メモ入力」セクションに編集可能なテキストエリアが表示される
- [ ] ユーザーが新規コメントを入力できる
- [ ] 保存ボタンをクリックすると、データベースに保存される
- [ ] 保存時、既存のコメント（スプレッドシートコメント）に新規コメントを追記する
- [ ] 保存後、即時同期でデータベース → スプレッドシートに同期される
- [ ] 保存後、通話メモ入力欄がクリアされる
- [ ] 保存後、成功メッセージが表示される
- [ ] 保存後、ページがリロードされ、最新のコメントが表示される

---

#### FR-3: 定期同期（スプレッドシート → データベース）

**優先度**: 高

**説明**: スプレッドシートの「コメント」カラムをデータベースに定期同期する。

**受け入れ基準**:
- [ ] 5分ごとにスプレッドシート → データベースの同期が実行される
- [ ] `comments` フィールドが同期対象に含まれる
- [ ] 同期時、データベースの `comments` フィールドが更新される

---

#### FR-4: 即時同期（データベース → スプレッドシート）

**優先度**: 高

**説明**: ユーザーが通話メモを保存したときに、データベース → スプレッドシートの即時同期を実行する。

**受け入れ基準**:
- [ ] 保存ボタンをクリックすると、データベースに保存される
- [ ] 保存後、数秒以内にスプレッドシートの「コメント」カラムに反映される
- [ ] `SyncQueue` を使用して即時同期を実行する

---

#### FR-5: クイックボタンの維持

**優先度**: 中

**説明**: 現在の「通話内容に残す言葉」のクイックボタンを維持する。

**受け入れ基準**:
- [ ] 「通話内容に残す言葉」のクイックボタンが通話メモ入力欄の上に表示される
- [ ] クイックボタンをクリックすると、通話メモ入力欄に定型文が追加される
- [ ] クイックボタンの無効化機能が正しく動作する

---

#### FR-6: 不通フィールドの維持

**優先度**: 中

**説明**: 現在の「不通」フィールドを維持する。

**受け入れ基準**:
- [ ] 「不通」フィールドが通話メモ入力欄の下に表示される（inquiry_date >= 2026-01-01の売主のみ）
- [ ] 「不通」「通電OK」ボタンが正しく動作する

---

#### FR-7: 活動ログの表示

**優先度**: 中

**説明**: 過去の活動ログ（電話、SMS、Email）を表示する。

**受け入れ基準**:
- [ ] 「コミュニケーション履歴」セクションに「過去の活動ログ」が表示される
- [ ] 活動ログには電話、SMS、Emailの履歴が表示される
- [ ] 活動ログは最新10件まで表示される
- [ ] 活動ログは読み取り専用である（編集不可）

---

### 3.2 非機能要件

#### NFR-1: パフォーマンス

- スプレッドシートコメントの読み込み時間は1秒以内
- 通話メモの保存処理は3秒以内に完了
- スプレッドシートへの同期は10秒以内に完了

#### NFR-2: ユーザビリティ

- スプレッドシートコメントと通話メモ入力が明確に分離されている
- 通話メモ入力欄は大きく、見やすいデザイン
- 保存ボタンは目立つ位置に配置

#### NFR-3: データ整合性

- 定期同期と即時同期が競合しない
- ユーザーが入力したコメントが消えない
- スプレッドシートとデータベースのデータが一致している

---

## 4. 画面設計

### 4.1 レイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ 📝 コミュニケーション履歴                                    │
├─────────────────────────────────────────────────────────────┤
│ スプレッドシートコメント（読み取り専用）                     │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ スプレッドシートのコメント内容がここに表示される         │ │
│ │ （読み取り専用、編集不可）                               │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 📋 過去の活動ログ                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 📞 通話 - Y 2026/02/02 10:30                             │ │
│ │ 不通                                                     │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │ 💬 SMS - Y 2026/02/01 15:00                              │ │
│ │ 査定Sメール送信                                          │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 📝 通話メモ入力                                              │
├─────────────────────────────────────────────────────────────┤
│ 通話内容に残す言葉                                           │
│ [B'] [木２] [土地面積] [太陽光] [一旦机上] [他社待ち] ...   │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 新規コメントを入力してください...                        │ │
│ │                                                           │ │
│ │ （編集可能なテキストエリア、10行以上）                   │ │
│ │                                                           │ │
│ │                                                           │ │
│ │                                                           │ │
│ │                                                           │ │
│ │                                                           │ │
│ │                                                           │ │
│ │                                                           │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 不通 *                                                       │
│ [不通] [通電OK]                                              │
├─────────────────────────────────────────────────────────────┤
│                        [保存]                                │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. データフロー

### 5.1 スプレッドシートコメント表示

```
スプレッドシート「コメント」列
  ↓ 定期同期（5分ごと）
データベース `comments` カラム
  ↓ API `GET /api/sellers/:id`
フロントエンド `seller.comments`
  ↓ 読み取り専用で表示
「スプレッドシートコメント」セクション
```

### 5.2 通話メモ入力

```
「通話メモ入力」セクション
  ↓ ユーザーが新規コメントを入力
  ↓ 保存ボタンをクリック
API `PUT /api/sellers/:id`
  ↓ 既存のコメント + 新規コメントを結合
データベース `comments` カラム
  ↓ 即時同期（数秒以内）
スプレッドシート「コメント」列
```

---

## 6. 技術仕様

### 6.1 データベース

**テーブル**: `sellers`

**カラム**: `comments` (TEXT)

**説明**: スプレッドシートの「コメント」カラムと同期される

### 6.2 スプレッドシート

**カラム名**: `コメント`

**説明**: 売主リストスプレッドシートの「コメント」カラム

### 6.3 API

**エンドポイント**: `PUT /api/sellers/:id`

**リクエストボディ**:
```json
{
  "comments": "既存のコメント\n新規コメント"
}
```

**レスポンス**:
```json
{
  "success": true,
  "message": "コメントを保存しました"
}
```

### 6.4 同期サービス

#### 定期同期（スプレッドシート → データベース）

**サービス**: `EnhancedAutoSyncService`

**同期間隔**: 5分ごと

**同期対象**: `comments` フィールドを含む

#### 即時同期（データベース → スプレッドシート）

**サービス**: `SyncQueue`

**トリガー**: `SellerService.updateSeller()` 実行時

**同期タイミング**: 数秒以内

---

## 7. テストケース

### 7.1 スプレッドシートコメント表示

| テストケース | 期待される結果 |
|------------|--------------|
| スプレッドシートに「コメント」がある売主を開く | スプレッドシートコメントが表示される |
| スプレッドシートに「コメント」がない売主を開く | スプレッドシートコメントが空欄で表示される |
| スプレッドシートコメントを編集しようとする | 編集できない（読み取り専用） |

### 7.2 通話メモ入力

| テストケース | 期待される結果 |
|------------|--------------|
| 通話メモ入力欄に新規コメントを入力して保存 | スプレッドシートの「コメント」カラムに追記される |
| 既存のコメントがある状態で新規コメントを入力して保存 | 既存のコメント + 改行 + 新規コメントがスプレッドシートに保存される |
| 空欄のまま保存ボタンをクリック | 保存ボタンが無効化されている |
| 保存後、通話メモ入力欄を確認 | 通話メモ入力欄がクリアされている |

### 7.3 同期の競合

| テストケース | 期待される結果 |
|------------|--------------|
| 通話メモを保存した直後に定期同期が実行される | ユーザーが入力したコメントが消えない |
| 定期同期中に通話メモを保存する | 両方の同期が正しく実行される |

---

## 8. 制約事項

### 8.1 既存機能への影響

- 「コミュニケーション情報」セクション（電話担当、連絡取りやすい時間帯、連絡方法）は変更しない
- 「AI要約（通話履歴サマリー）」セクションは変更しない
- 左側50%のレイアウトは変更しない

### 8.2 スプレッドシートの制約

- スプレッドシートの「コメント」カラムは既存のカラムを使用する
- 新しいカラムは追加しない

---

## 9. 成功基準

1. **機能性**: スプレッドシートコメントと通話メモ入力が明確に分離されている
2. **データ整合性**: 定期同期と即時同期が競合せず、ユーザーが入力したコメントが消えない
3. **ユーザビリティ**: ユーザーがスプレッドシートコメントを確認しながら新規コメントを入力できる
4. **パフォーマンス**: 保存処理が3秒以内に完了する

---

## 10. リスクと対策

### リスク1: 同期の競合

**対策**: 定期同期では `comments` フィールドを同期対象に含め、即時同期では `SyncQueue` を使用して順次処理する

### リスク2: ユーザーが入力したコメントが消える

**対策**: 通話メモ入力欄は独立しており、定期同期の影響を受けない

### リスク3: スプレッドシートコメントが更新されない

**対策**: 保存後にページをリロードして最新のコメントを表示する

---

## 11. 今後の拡張

- コメントの履歴表示（過去のコメントを時系列で表示）
- コメントの検索機能
- コメントのタグ付け機能

---

**作成日**: 2026年2月2日  
**作成者**: Kiro AI  
**バージョン**: 2.0  
**更新日**: 2026年2月2日（分離型設計に変更）
