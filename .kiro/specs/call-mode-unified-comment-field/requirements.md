# 通話モードページ：コメント欄統合機能

## 1. 概要

通話モードページの「コミュニケーション履歴」セクションと「通話メモ入力」セクションを統合し、スプレッドシートの「コメント」カラムと双方向同期する大きな統一コメント欄を作成します。

## 2. 背景

### 現在の問題点

1. **コメント表示が分散している**
   - 「コミュニケーション履歴」セクション：スプレッドシートのコメント + 活動ログ（電話、SMS、Email）
   - 「通話メモ入力」セクション：新規入力用のテキストエリア
   - 2つのセクションが別々に存在し、情報が分散している

2. **スプレッドシートとの同期が不明確**
   - 「通話メモ入力」で入力した内容がスプレッドシートの「コメント」カラムに反映されるのか不明確
   - 「コミュニケーション履歴」のスプレッドシートコメントが編集できない

3. **UI/UXの問題**
   - 2つのセクションが縦に並んでいて、画面スペースを無駄に使っている
   - コメントの全体像が把握しにくい

### ユーザーの要望

> 「コミュニケーション履歴でスプレッドシートコメントがありますが、これと通話メモ入力の通話内容の枠を一緒の枠にしたい。つまり、コメント表示として大きな枠にして、スプシのコメント欄をここに反映させて、こちらから入力するのもスプシに反映させる。」

## 3. 要件定義

### 3.1 機能要件

#### FR-1: 統一コメント欄の作成

**優先度**: 高

**説明**: 「コミュニケーション履歴」と「通話メモ入力」を統合し、1つの大きなコメント欄を作成する。

**受け入れ基準**:
- [ ] 「コミュニケーション履歴」セクションと「通話メモ入力」セクションが統合されている
- [ ] 統一コメント欄は大きな編集可能なテキストエリアである
- [ ] スプレッドシートの「コメント」カラムの内容が統一コメント欄に表示される
- [ ] 統一コメント欄で入力した内容がスプレッドシートの「コメント」カラムに保存される

---

#### FR-2: スプレッドシートとの双方向同期

**優先度**: 高

**説明**: 統一コメント欄とスプレッドシートの「コメント」カラムを双方向同期する。

**受け入れ基準**:
- [ ] ページ読み込み時、スプレッドシートの「コメント」カラムの内容が統一コメント欄に表示される
- [ ] 統一コメント欄で入力した内容を保存すると、スプレッドシートの「コメント」カラムに反映される
- [ ] 保存後、統一コメント欄の内容がクリアされる（次回の入力に備える）
- [ ] スプレッドシートで「コメント」カラムを編集した場合、次回ページ読み込み時に統一コメント欄に反映される

---

#### FR-3: 活動ログの表示

**優先度**: 中

**説明**: 統一コメント欄の下に、過去の活動ログ（電話、SMS、Email）を表示する。

**受け入れ基準**:
- [ ] 統一コメント欄の下に「過去の活動ログ」セクションが表示される
- [ ] 活動ログには電話、SMS、Emailの履歴が表示される
- [ ] 活動ログは最新10件まで表示される
- [ ] 活動ログは読み取り専用である（編集不可）

---

#### FR-4: クイックボタンの維持

**優先度**: 中

**説明**: 現在の「通話内容に残す言葉」のクイックボタンを維持する。

**受け入れ基準**:
- [ ] 「通話内容に残す言葉」のクイックボタンが統一コメント欄の上に表示される
- [ ] クイックボタンをクリックすると、統一コメント欄に定型文が追加される
- [ ] クイックボタンの無効化機能が正しく動作する

---

#### FR-5: 不通フィールドの維持

**優先度**: 中

**説明**: 現在の「不通」フィールドを維持する。

**受け入れ基準**:
- [ ] 「不通」フィールドが統一コメント欄の下に表示される（inquiry_date >= 2026-01-01の売主のみ）
- [ ] 「不通」「通電OK」ボタンが正しく動作する

---

#### FR-6: 保存ボタンの動作

**優先度**: 高

**説明**: 保存ボタンをクリックすると、統一コメント欄の内容がスプレッドシートの「コメント」カラムに追記される。

**受け入れ基準**:
- [ ] 保存ボタンをクリックすると、統一コメント欄の内容がスプレッドシートの「コメント」カラムに追記される
- [ ] 追記時、既存のコメントと新規コメントの間に改行が挿入される
- [ ] 保存後、統一コメント欄の内容がクリアされる
- [ ] 保存後、成功メッセージが表示される
- [ ] 保存後、ページがリロードされ、最新のコメントが表示される

---

### 3.2 非機能要件

#### NFR-1: パフォーマンス

- 統一コメント欄の読み込み時間は1秒以内
- 保存処理は3秒以内に完了

#### NFR-2: ユーザビリティ

- 統一コメント欄は大きく、見やすいデザイン
- クイックボタンは現在の位置を維持
- 保存ボタンは目立つ位置に配置

#### NFR-3: 互換性

- 既存のスプレッドシートの「コメント」カラムと互換性を保つ
- 既存の活動ログ機能と互換性を保つ

---

## 4. 画面設計

### 4.1 統一コメント欄のレイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ 📝 コメント                                                  │
├─────────────────────────────────────────────────────────────┤
│ 通話内容に残す言葉                                           │
│ [B'] [木２] [土地面積] [太陽光] [一旦机上] [他社待ち] ...   │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ スプレッドシートのコメント内容がここに表示される         │ │
│ │                                                           │ │
│ │ （編集可能なテキストエリア、10行以上）                   │ │
│ │                                                           │ │
│ │                                                           │ │
│ │                                                           │ │
│ │                                                           │ │
│ │                                                           │ │
│ │                                                           │ │
│ │                                                           │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 不通 *                                                       │
│ [不通] [通電OK]                                              │
├─────────────────────────────────────────────────────────────┤
│                        [保存]                                │
├─────────────────────────────────────────────────────────────┤
│ 📋 過去の活動ログ                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 📞 通話 - Y 2026/02/02 10:30                             │ │
│ │ 不通                                                     │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │ 💬 SMS - Y 2026/02/01 15:00                              │ │
│ │ 査定Sメール送信                                          │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 レイアウトの変更点

**変更前**:
- 左側50%：売主情報、物件情報、訪問予約など
- 右側50%：通話メモ入力 + コミュニケーション履歴

**変更後**:
- 左側50%：売主情報、物件情報、訪問予約など（変更なし）
- 右側50%：統一コメント欄 + 過去の活動ログ

---

## 5. データフロー

### 5.1 ページ読み込み時

```
1. ユーザーが通話モードページを開く
   ↓
2. バックエンドAPIが売主データを取得
   ↓
3. 売主データの`comments`フィールドを統一コメント欄に表示
   ↓
4. 活動ログ（電話、SMS、Email）を取得して表示
```

### 5.2 保存時

```
1. ユーザーが統一コメント欄に新規コメントを入力
   ↓
2. ユーザーが「保存」ボタンをクリック
   ↓
3. フロントエンドが既存のコメント + 新規コメントを結合
   ↓
4. バックエンドAPIに`comments`フィールドを更新するリクエストを送信
   ↓
5. バックエンドがデータベースの`comments`フィールドを更新
   ↓
6. バックエンドがスプレッドシートの「コメント」カラムを更新
   ↓
7. フロントエンドが成功メッセージを表示
   ↓
8. フロントエンドがページをリロード（最新のコメントを表示）
```

---

## 6. 技術仕様

### 6.1 データベース

**テーブル**: `sellers`

**カラム**: `comments` (TEXT)

**説明**: スプレッドシートの「コメント」カラムと同期される

### 6.2 スプレッドシート

**カラム名**: `コメント`

**説明**: 売主リストスプレッドシートの「コメント」カラム

### 6.3 API

**エンドポイント**: `PUT /api/sellers/:id`

**リクエストボディ**:
```json
{
  "comments": "既存のコメント\n新規コメント"
}
```

**レスポンス**:
```json
{
  "success": true,
  "message": "コメントを保存しました"
}
```

---

## 7. テストケース

### 7.1 統一コメント欄の表示

| テストケース | 期待される結果 |
|------------|--------------|
| スプレッドシートに「コメント」がある売主を開く | 統一コメント欄にコメントが表示される |
| スプレッドシートに「コメント」がない売主を開く | 統一コメント欄が空欄で表示される |

### 7.2 コメントの保存

| テストケース | 期待される結果 |
|------------|--------------|
| 統一コメント欄に新規コメントを入力して保存 | スプレッドシートの「コメント」カラムに追記される |
| 既存のコメントがある状態で新規コメントを入力して保存 | 既存のコメント + 改行 + 新規コメントがスプレッドシートに保存される |
| 空欄のまま保存ボタンをクリック | 保存ボタンが無効化されている |

### 7.3 クイックボタン

| テストケース | 期待される結果 |
|------------|--------------|
| 「B'」ボタンをクリック | 統一コメント欄に「価格が知りたかっただけ」が追加される |
| 「木２」ボタンをクリック | 統一コメント欄に「木造２F」が追加される |

### 7.4 活動ログの表示

| テストケース | 期待される結果 |
|------------|--------------|
| 活動ログがある売主を開く | 統一コメント欄の下に活動ログが表示される |
| 活動ログがない売主を開く | 「過去の活動ログはありません」と表示される |

---

## 8. 制約事項

### 8.1 既存機能への影響

- 「コミュニケーション情報」セクション（電話担当、連絡取りやすい時間帯、連絡方法）は変更しない
- 「AI要約（通話履歴サマリー）」セクションは変更しない
- 左側50%のレイアウトは変更しない

### 8.2 スプレッドシートの制約

- スプレッドシートの「コメント」カラムは既存のカラムを使用する
- 新しいカラムは追加しない

---

## 9. 成功基準

1. **機能性**: 統一コメント欄とスプレッドシートの「コメント」カラムが双方向同期される
2. **ユーザビリティ**: ユーザーが1つの大きなコメント欄でコメントを管理できる
3. **互換性**: 既存のスプレッドシートデータと互換性を保つ
4. **パフォーマンス**: 保存処理が3秒以内に完了する

---

## 10. リスクと対策

### リスク1: スプレッドシートの同期遅延

**対策**: 保存後にページをリロードして最新のコメントを表示する

### リスク2: 既存のコメントが上書きされる

**対策**: 保存時に既存のコメントと新規コメントを結合する（追記方式）

### リスク3: 活動ログとコメントの混同

**対策**: 活動ログは別セクションに表示し、読み取り専用にする

---

## 11. 今後の拡張

- コメントの履歴表示（過去のコメントを時系列で表示）
- コメントの検索機能
- コメントのタグ付け機能

---

**作成日**: 2026年2月2日  
**作成者**: Kiro AI  
**バージョン**: 1.0
