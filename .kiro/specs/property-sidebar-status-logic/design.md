# ç‰©ä»¶ãƒªã‚¹ãƒˆï¼šã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚«ãƒ†ã‚´ãƒªãƒ¼ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®šä»•æ§˜ - è¨­è¨ˆæ›¸

## 1. æ¦‚è¦

ç‰©ä»¶ãƒªã‚¹ãƒˆã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¤‡æ•°ã®ã‚«ãƒ©ãƒ ã‹ã‚‰åˆ¤å®šã—ã¦è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã®è¨­è¨ˆæ›¸ã§ã™ã€‚

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Sheets                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ç‰©ä»¶ãƒªã‚¹ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼ˆãƒ¡ã‚¤ãƒ³ã‚½ãƒ¼ã‚¹ï¼‰              â”‚
â”‚    - ç‰©ä»¶ç•ªå·ã€atbbæˆç´„æ¸ˆã¿/éå…¬é–‹ã€å ±å‘Šæ—¥ã€ç¢ºèªã€ç­‰       â”‚
â”‚ 2. æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆï¼ˆè£œåŠ©æƒ…å ±ï¼‰                              â”‚
â”‚    - ç‰©ä»¶ç•ªå·ã€å…¬é–‹äºˆå®šæ—¥                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    15åˆ†ã”ã¨ã«åŒæœŸ
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PropertyListingSyncService                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ç‰©ä»¶ãƒªã‚¹ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’èª­ã¿å–ã‚Š                    â”‚
â”‚ 2. æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã‚’1å›ã ã‘èª­ã¿å–ã‚Š                         â”‚
â”‚ 3. å„ç‰©ä»¶ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨ˆç®—ï¼ˆcalculateSidebarStatusï¼‰      â”‚
â”‚ 4. property_listingsãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    DBã«ä¿å­˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase (property_listings)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - property_number                                           â”‚
â”‚ - atbb_status                                               â”‚
â”‚ - sidebar_status â† æ–°è¦è¿½åŠ                                 â”‚
â”‚ - ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    APIã§å–å¾—
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆç‰©ä»¶ãƒªã‚¹ãƒˆç”»é¢ï¼‰                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼š                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚ â”‚ ç‰©ä»¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹      â”‚                                     â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                     â”‚
â”‚ â”‚ æœªå ±å‘Š (å±±æœ¬) [5]   â”‚ â† sidebar_statusã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–       â”‚
â”‚ â”‚ æœªå®Œäº† [3]          â”‚                                     â”‚
â”‚ â”‚ æœ¬æ—¥å…¬é–‹äºˆå®š [2]    â”‚                                     â”‚
â”‚ â”‚ ...                 â”‚                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **åŒæœŸé–‹å§‹**ï¼ˆ15åˆ†ã”ã¨ï¼‰
2. **ç‰©ä»¶ãƒªã‚¹ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿å–ã‚Š**ï¼ˆ1å›ï¼‰
3. **æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆèª­ã¿å–ã‚Š**ï¼ˆ1å›ï¼‰
4. **å„ç‰©ä»¶ã®å‡¦ç†**ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰:
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—ï¼ˆ`calculateSidebarStatus()`ï¼‰
   - DBä¿å­˜ï¼ˆupsertï¼‰
5. **åŒæœŸå®Œäº†**

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 3.1 ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´

**ãƒ†ãƒ¼ãƒ–ãƒ«**: `property_listings`

**æ–°è¦ã‚«ãƒ©ãƒ **:
```sql
ALTER TABLE property_listings
ADD COLUMN sidebar_status TEXT;
```

**èª¬æ˜**:
- `sidebar_status`: è¨ˆç®—ã•ã‚ŒãŸã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆä¾‹: "æœªå ±å‘Š å±±æœ¬", "æœªå®Œäº†", "Yå°‚ä»»å…¬é–‹ä¸­"ï¼‰
- NULLè¨±å¯ï¼ˆè©²å½“ãªã—ã®å ´åˆã¯ç©ºæ–‡å­—ã¾ãŸã¯NULLï¼‰

### 3.2 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚’é«˜é€ŸåŒ–
CREATE INDEX idx_property_listings_sidebar_status 
ON property_listings(sidebar_status);
```

## 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

### 4.1 PropertyListingSyncService ã®æ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/api/src/services/PropertyListingSyncService.ts`


#### 4.1.1 runFullSync() ãƒ¡ã‚½ãƒƒãƒ‰ã®å¤‰æ›´

```typescript
async runFullSync(triggeredBy: 'scheduled' | 'manual' = 'scheduled'): Promise<PropertyListingSyncResult> {
  // ... æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†
  
  // 1. ç‰©ä»¶ãƒªã‚¹ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’èª­ã¿å–ã‚Šï¼ˆæ—¢å­˜ï¼‰
  const rows = await this.propertyListSheetsClient.readAll();
  
  // 2. æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã‚’1å›ã ã‘èª­ã¿å–ã‚Šï¼ˆæ–°è¦ï¼‰
  const gyomuListData = await this.gyomuListSheetsClient.readAll();
  
  // 3. å„ç‰©ä»¶ã‚’å‡¦ç†
  for (const row of rows) {
    // ... æ—¢å­˜ã®å‡¦ç†
    
    // 4. ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨ˆç®—ï¼ˆæ–°è¦ï¼‰
    const sidebarStatus = this.calculateSidebarStatus(row, gyomuListData);
    
    // 5. propertyDataã«è¿½åŠ 
    const propertyData = {
      // ... æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      sidebar_status: sidebarStatus,  // â† æ–°è¦è¿½åŠ 
      updated_at: new Date().toISOString(),
    };
    
    // 6. DBä¿å­˜ï¼ˆæ—¢å­˜ï¼‰
    await this.supabase.from('property_listings').upsert(propertyData);
  }
}
```

#### 4.1.2 calculateSidebarStatus() ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆæ–°è¦ï¼‰

```typescript
/**
 * ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨ˆç®—
 * @param row ç‰©ä»¶ãƒªã‚¹ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®1è¡Œ
 * @param gyomuListData æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã®å…¨ãƒ‡ãƒ¼ã‚¿
 * @returns ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ–‡å­—åˆ—ï¼ˆä¾‹: "æœªå ±å‘Š å±±æœ¬", "æœªå®Œäº†", ""ï¼‰
 */
private calculateSidebarStatus(row: any, gyomuListData: any[]): string {
  const propertyNumber = String(row['ç‰©ä»¶ç•ªå·'] || '');
  const atbbStatus = String(row['atbbæˆç´„æ¸ˆã¿/éå…¬é–‹'] || '');
  
  // â‘  æœªå ±å‘Šï¼ˆæœ€å„ªå…ˆï¼‰
  const reportDate = row['å ±å‘Šæ—¥'];
  if (reportDate && this.isDateBeforeOrToday(reportDate)) {
    const assignee = row['å ±å‘Šæ‹…å½“_override'] || row['å ±å‘Šæ‹…å½“'] || '';
    return assignee ? `æœªå ±å‘Š ${assignee}` : 'æœªå ±å‘Š';
  }
  
  // â‘¡ æœªå®Œäº†
  if (row['ç¢ºèª'] === 'æœª') {
    return 'æœªå®Œäº†';
  }
  
  // â‘¢ éå…¬é–‹äºˆå®šï¼ˆç¢ºèªå¾Œï¼‰
  if (row['ä¸€èˆ¬åª’ä»‹éå…¬é–‹ï¼ˆä»®ï¼‰'] === 'éå…¬é–‹äºˆå®š') {
    return 'éå…¬é–‹äºˆå®šï¼ˆç¢ºèªå¾Œï¼‰';
  }
  
  // â‘£ ä¸€èˆ¬åª’ä»‹ã®æ²è¼‰ç¢ºèªæœª
  if (row['ï¼‘ç¤¾æ²è¼‰'] === 'æœªç¢ºèª') {
    return 'ä¸€èˆ¬åª’ä»‹ã®æ²è¼‰ç¢ºèªæœª';
  }
  
  // â‘¤ æœ¬æ—¥å…¬é–‹äºˆå®š
  if (atbbStatus.includes('å…¬é–‹å‰')) {
    const scheduledDate = this.lookupGyomuList(propertyNumber, gyomuListData, 'å…¬é–‹äºˆå®šæ—¥');
    if (scheduledDate && this.isDateBeforeOrToday(scheduledDate)) {
      return 'æœ¬æ—¥å…¬é–‹äºˆå®š';
    }
  }
  
  // â‘¥ SUUMO / ãƒ¬ã‚¤ãƒ³ã‚ºç™»éŒ²å¿…è¦
  if (atbbStatus === 'ä¸€èˆ¬ãƒ»å…¬é–‹ä¸­' || atbbStatus === 'å°‚ä»»ãƒ»å…¬é–‹ä¸­') {
    const scheduledDate = this.lookupGyomuList(propertyNumber, gyomuListData, 'å…¬é–‹äºˆå®šæ—¥');
    const suumoUrl = row['Suumo URL'];
    const suumoRegistration = row['Suumoç™»éŒ²'];
    
    if (scheduledDate && 
        this.isDateBeforeYesterday(scheduledDate) && 
        !suumoUrl && 
        suumoRegistration !== 'Sä¸è¦') {
      return atbbStatus === 'ä¸€èˆ¬ãƒ»å…¬é–‹ä¸­' 
        ? 'SUUMO URLã€€è¦ç™»éŒ²' 
        : 'ãƒ¬ã‚¤ãƒ³ã‚ºç™»éŒ²ï¼‹SUUMOç™»éŒ²';
    }
  }
  
  // â‘¦ è²·ä»˜ç”³è¾¼ã¿ï¼ˆå†…è¦§ãªã—ï¼‰ï¼’
  const kaitsukeStatus = row['è²·ä»˜'];
  if (
    (kaitsukeStatus === 'å°‚ä»»ç‰‡æ‰‹' && atbbStatus === 'å°‚ä»»ãƒ»å…¬é–‹ä¸­') ||
    (kaitsukeStatus === 'ä¸€èˆ¬ä»–æ±º' && atbbStatus === 'ä¸€èˆ¬ãƒ»å…¬é–‹ä¸­') ||
    (kaitsukeStatus === 'å°‚ä»»ä¸¡æ‰‹' && atbbStatus === 'å°‚ä»»ãƒ»å…¬é–‹ä¸­') ||
    (kaitsukeStatus === 'ä¸€èˆ¬ä¸¡æ‰‹' && atbbStatus === 'ä¸€èˆ¬ãƒ»å…¬é–‹ä¸­') ||
    (kaitsukeStatus === 'ä¸€èˆ¬ç‰‡æ‰‹' && atbbStatus === 'ä¸€èˆ¬ãƒ»å…¬é–‹ä¸­')
  ) {
    return 'è²·ä»˜ç”³è¾¼ã¿ï¼ˆå†…è¦§ãªã—ï¼‰ï¼’';
  }
  
  // â‘§ å…¬é–‹å‰æƒ…å ±
  if (atbbStatus === 'ä¸€èˆ¬ãƒ»å…¬é–‹å‰' || atbbStatus === 'å°‚ä»»ãƒ»å…¬é–‹å‰') {
    return 'å…¬é–‹å‰æƒ…å ±';
  }
  
  // â‘¨ éå…¬é–‹ï¼ˆé…ä¿¡ãƒ¡ãƒ¼ãƒ«ã®ã¿ï¼‰
  if (atbbStatus === 'éå…¬é–‹ï¼ˆé…ä¿¡ãƒ¡ãƒ¼ãƒ«ã®ã¿ï¼‰') {
    return 'éå…¬é–‹ï¼ˆé…ä¿¡ãƒ¡ãƒ¼ãƒ«ã®ã¿ï¼‰';
  }
  
  // â‘© ä¸€èˆ¬å…¬é–‹ä¸­ç‰©ä»¶
  if (atbbStatus === 'ä¸€èˆ¬ãƒ»å…¬é–‹ä¸­') {
    return 'ä¸€èˆ¬å…¬é–‹ä¸­ç‰©ä»¶';
  }
  
  // â‘ª å°‚ä»»ãƒ»å…¬é–‹ä¸­ï¼ˆæ‹…å½“åˆ¥ï¼‰
  if (atbbStatus === 'å°‚ä»»ãƒ»å…¬é–‹ä¸­') {
    const assignee = row['æ‹…å½“åï¼ˆå–¶æ¥­ï¼‰'];
    return this.getAssigneeStatus(assignee);
  }
  
  // â‘« ãã‚Œä»¥å¤–
  return '';
}
```

#### 4.1.3 ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆæ–°è¦ï¼‰

```typescript
/**
 * æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ï¼ˆLOOKUPç›¸å½“ï¼‰
 */
private lookupGyomuList(
  propertyNumber: string, 
  gyomuListData: any[], 
  columnName: string
): any {
  const row = gyomuListData.find(r => r['ç‰©ä»¶ç•ªå·'] === propertyNumber);
  return row ? row[columnName] : null;
}

/**
 * æ—¥ä»˜ãŒä»Šæ—¥ä»¥å‰ã‹ãƒã‚§ãƒƒã‚¯
 */
private isDateBeforeOrToday(dateValue: any): boolean {
  if (!dateValue) return false;
  const date = this.parseDate(dateValue);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  return date <= today;
}

/**
 * æ—¥ä»˜ãŒæ˜¨æ—¥ä»¥å‰ã‹ãƒã‚§ãƒƒã‚¯
 */
private isDateBeforeYesterday(dateValue: any): boolean {
  if (!dateValue) return false;
  const date = this.parseDate(dateValue);
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  yesterday.setHours(0, 0, 0, 0);
  return date <= yesterday;
}

/**
 * æ—¥ä»˜ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚·ãƒªã‚¢ãƒ«å€¤å¯¾å¿œï¼‰
 */
private parseDate(dateValue: any): Date {
  // ã‚·ãƒªã‚¢ãƒ«å€¤ã®å ´åˆï¼ˆæ•°å€¤ï¼‰
  if (typeof dateValue === 'number') {
    const excelEpoch = new Date(1899, 11, 30);
    return new Date(excelEpoch.getTime() + dateValue * 86400000);
  }
  
  // æ–‡å­—åˆ—ã®å ´åˆ
  return new Date(dateValue);
}

/**
 * æ‹…å½“è€…åã‹ã‚‰å°‚ä»»å…¬é–‹ä¸­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
 */
private getAssigneeStatus(assignee: string): string {
  const mapping = this.loadStaffMapping();
  return mapping[assignee] || 'å°‚ä»»ãƒ»å…¬é–‹ä¸­';
}

/**
 * æ‹…å½“è€…ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿
 */
private loadStaffMapping(): Record<string, string> {
  // TODO: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  // ç¾åœ¨ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰
  return {
    'å±±æœ¬': 'Yå°‚ä»»å…¬é–‹ä¸­',
    'ç”Ÿé‡': 'ç”Ÿãƒ»å°‚ä»»å…¬é–‹ä¸­',
    'ä¹…': 'ä¹…ãƒ»å°‚ä»»å…¬é–‹ä¸­',
    'è£': 'Uå°‚ä»»å…¬é–‹ä¸­',
    'æ—': 'æ—ãƒ»å°‚ä»»å…¬é–‹ä¸­',
    'å›½åºƒ': 'Kå°‚ä»»å…¬é–‹ä¸­',
    'æœ¨æ‘': 'Rå°‚ä»»å…¬é–‹ä¸­',
    'è§’äº•': 'Iå°‚ä»»å…¬é–‹ä¸­',
  };
}
```

### 4.2 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/api/config/staff-mapping.json`

```json
{
  "å±±æœ¬": "Yå°‚ä»»å…¬é–‹ä¸­",
  "ç”Ÿé‡": "ç”Ÿãƒ»å°‚ä»»å…¬é–‹ä¸­",
  "ä¹…": "ä¹…ãƒ»å°‚ä»»å…¬é–‹ä¸­",
  "è£": "Uå°‚ä»»å…¬é–‹ä¸­",
  "æ—": "æ—ãƒ»å°‚ä»»å…¬é–‹ä¸­",
  "å›½åºƒ": "Kå°‚ä»»å…¬é–‹ä¸­",
  "æœ¨æ‘": "Rå°‚ä»»å…¬é–‹ä¸­",
  "è§’äº•": "Iå°‚ä»»å…¬é–‹ä¸­"
}
```

**èª­ã¿è¾¼ã¿æ–¹æ³•**:
```typescript
import staffMapping from '../config/staff-mapping.json';

private loadStaffMapping(): Record<string, string> {
  return staffMapping;
}
```

## 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

### 5.1 ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/PropertySidebarStatus.tsx`


```typescript
import React, { useMemo } from 'react';

interface PropertySidebarStatusProps {
  properties: any[];
  selectedStatus: string | null;
  onStatusSelect: (status: string | null) => void;
}

export const PropertySidebarStatus: React.FC<PropertySidebarStatusProps> = ({
  properties,
  selectedStatus,
  onStatusSelect,
}) => {
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const statusGroups = useMemo(() => {
    const groups: Record<string, number> = {};
    
    properties.forEach(property => {
      const status = property.sidebar_status || 'ãã®ä»–';
      groups[status] = (groups[status] || 0) + 1;
    });
    
    return groups;
  }, [properties]);
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å„ªå…ˆé †ä½é †ã«ã‚½ãƒ¼ãƒˆ
  const sortedStatuses = useMemo(() => {
    const statusOrder = [
      'æœªå ±å‘Š',
      'æœªå®Œäº†',
      'éå…¬é–‹äºˆå®šï¼ˆç¢ºèªå¾Œï¼‰',
      'ä¸€èˆ¬åª’ä»‹ã®æ²è¼‰ç¢ºèªæœª',
      'æœ¬æ—¥å…¬é–‹äºˆå®š',
      'SUUMO URLã€€è¦ç™»éŒ²',
      'ãƒ¬ã‚¤ãƒ³ã‚ºç™»éŒ²ï¼‹SUUMOç™»éŒ²',
      'è²·ä»˜ç”³è¾¼ã¿ï¼ˆå†…è¦§ãªã—ï¼‰ï¼’',
      'å…¬é–‹å‰æƒ…å ±',
      'éå…¬é–‹ï¼ˆé…ä¿¡ãƒ¡ãƒ¼ãƒ«ã®ã¿ï¼‰',
      'ä¸€èˆ¬å…¬é–‹ä¸­ç‰©ä»¶',
      'Yå°‚ä»»å…¬é–‹ä¸­',
      'ç”Ÿãƒ»å°‚ä»»å…¬é–‹ä¸­',
      'ä¹…ãƒ»å°‚ä»»å…¬é–‹ä¸­',
      'Uå°‚ä»»å…¬é–‹ä¸­',
      'æ—ãƒ»å°‚ä»»å…¬é–‹ä¸­',
      'Kå°‚ä»»å…¬é–‹ä¸­',
      'Rå°‚ä»»å…¬é–‹ä¸­',
      'Iå°‚ä»»å…¬é–‹ä¸­',
      'ãã®ä»–',
    ];
    
    return Object.keys(statusGroups).sort((a, b) => {
      // æœªå ±å‘Šç³»ã¯æ‹…å½“è€…åã§ã‚½ãƒ¼ãƒˆ
      if (a.startsWith('æœªå ±å‘Š') && b.startsWith('æœªå ±å‘Š')) {
        return a.localeCompare(b);
      }
      
      // å„ªå…ˆé †ä½é †
      const indexA = statusOrder.findIndex(s => a.startsWith(s));
      const indexB = statusOrder.findIndex(s => b.startsWith(s));
      
      if (indexA === -1 && indexB === -1) return a.localeCompare(b);
      if (indexA === -1) return 1;
      if (indexB === -1) return -1;
      
      return indexA - indexB;
    });
  }, [statusGroups]);
  
  return (
    <div className="property-sidebar-status">
      <h3>ç‰©ä»¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
      <ul className="status-list">
        {/* å…¨ã¦è¡¨ç¤º */}
        <li
          className={selectedStatus === null ? 'active' : ''}
          onClick={() => onStatusSelect(null)}
        >
          å…¨ã¦ [{properties.length}]
        </li>
        
        {/* å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */}
        {sortedStatuses.map(status => (
          <li
            key={status}
            className={selectedStatus === status ? 'active' : ''}
            onClick={() => onStatusSelect(status)}
          >
            {status} [{statusGroups[status]}]
          </li>
        ))}
      </ul>
    </div>
  );
};
```

### 5.2 ç‰©ä»¶ãƒªã‚¹ãƒˆç”»é¢ã®å¤‰æ›´

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/pages/PropertyListPage.tsx`ï¼ˆã¾ãŸã¯è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

```typescript
import React, { useState, useMemo } from 'react';
import { PropertySidebarStatus } from '../components/PropertySidebarStatus';

export const PropertyListPage: React.FC = () => {
  const [properties, setProperties] = useState<any[]>([]);
  const [selectedStatus, setSelectedStatus] = useState<string | null>(null);
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const filteredProperties = useMemo(() => {
    if (!selectedStatus) return properties;
    
    return properties.filter(property => {
      const status = property.sidebar_status || 'ãã®ä»–';
      return status === selectedStatus;
    });
  }, [properties, selectedStatus]);
  
  return (
    <div className="property-list-page">
      {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */}
      <aside className="sidebar">
        <PropertySidebarStatus
          properties={properties}
          selectedStatus={selectedStatus}
          onStatusSelect={setSelectedStatus}
        />
      </aside>
      
      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <main className="main-content">
        <h1>ç‰©ä»¶ãƒªã‚¹ãƒˆ</h1>
        {/* ç‰©ä»¶ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« */}
        <PropertyTable properties={filteredProperties} />
      </main>
    </div>
  );
};
```

### 5.3 ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/PropertySidebarStatus.css`

```css
.property-sidebar-status {
  padding: 1rem;
  background: #f5f5f5;
  border-radius: 8px;
}

.property-sidebar-status h3 {
  margin: 0 0 1rem 0;
  font-size: 1.1rem;
  font-weight: 600;
}

.status-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.status-list li {
  padding: 0.5rem 0.75rem;
  margin-bottom: 0.25rem;
  cursor: pointer;
  border-radius: 4px;
  transition: background-color 0.2s;
}

.status-list li:hover {
  background-color: #e0e0e0;
}

.status-list li.active {
  background-color: #1976d2;
  color: white;
  font-weight: 600;
}

/* æœªå ±å‘Šã¯èµ¤è‰² */
.status-list li:has-text("æœªå ±å‘Š") {
  color: #d32f2f;
}

/* æœªå®Œäº†ã¯ã‚ªãƒ¬ãƒ³ã‚¸è‰² */
.status-list li:has-text("æœªå®Œäº†") {
  color: #f57c00;
}
```

## 6. APIè¨­è¨ˆ

### 6.1 æ—¢å­˜APIã®å¤‰æ›´

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/properties`

**å¤‰æ›´å†…å®¹**: `sidebar_status`ã‚«ãƒ©ãƒ ã‚’å«ã‚ã¦è¿”ã™

```typescript
// backend/src/routes/properties.ts

router.get('/', async (req, res) => {
  const { data, error } = await supabase
    .from('property_listings')
    .select('*')  // sidebar_statusã‚‚å«ã¾ã‚Œã‚‹
    .order('updated_at', { ascending: false });
  
  if (error) {
    return res.status(500).json({ error: error.message });
  }
  
  res.json(data);
});
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
[
  {
    "id": "uuid",
    "property_number": "AA13501",
    "address": "å¤§åˆ†å¸‚ä¸­å¤®ç”º1-1-1",
    "atbb_status": "å°‚ä»»ãƒ»å…¬é–‹ä¸­",
    "sidebar_status": "Yå°‚ä»»å…¬é–‹ä¸­",
    "updated_at": "2026-02-12T10:00:00Z"
  }
]
```

## 7. ãƒ†ã‚¹ãƒˆè¨­è¨ˆ

### 7.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/api/src/services/PropertyListingSyncService.test.ts`

```typescript
import { PropertyListingSyncService } from './PropertyListingSyncService';

describe('PropertyListingSyncService', () => {
  let service: PropertyListingSyncService;
  
  beforeEach(() => {
    service = new PropertyListingSyncService(
      process.env.SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_KEY!
    );
  });
  
  describe('calculateSidebarStatus', () => {
    const gyomuListData = [
      { 'ç‰©ä»¶ç•ªå·': 'AA13501', 'å…¬é–‹äºˆå®šæ—¥': '2026-02-10' },
    ];
    
    test('â‘  æœªå ±å‘Šï¼ˆæœ€å„ªå…ˆï¼‰', () => {
      const row = {
        'ç‰©ä»¶ç•ªå·': 'AA13501',
        'å ±å‘Šæ—¥': '2026-02-11',
        'å ±å‘Šæ‹…å½“': 'å±±æœ¬',
      };
      
      const result = service['calculateSidebarStatus'](row, gyomuListData);
      expect(result).toBe('æœªå ±å‘Š å±±æœ¬');
    });
    
    test('â‘¡ æœªå®Œäº†', () => {
      const row = {
        'ç‰©ä»¶ç•ªå·': 'AA13501',
        'ç¢ºèª': 'æœª',
      };
      
      const result = service['calculateSidebarStatus'](row, gyomuListData);
      expect(result).toBe('æœªå®Œäº†');
    });
    
    test('â‘ª å°‚ä»»ãƒ»å…¬é–‹ä¸­ï¼ˆæ‹…å½“åˆ¥ï¼‰', () => {
      const row = {
        'ç‰©ä»¶ç•ªå·': 'AA13501',
        'atbbæˆç´„æ¸ˆã¿/éå…¬é–‹': 'å°‚ä»»ãƒ»å…¬é–‹ä¸­',
        'æ‹…å½“åï¼ˆå–¶æ¥­ï¼‰': 'å±±æœ¬',
      };
      
      const result = service['calculateSidebarStatus'](row, gyomuListData);
      expect(result).toBe('Yå°‚ä»»å…¬é–‹ä¸­');
    });
    
    test('â‘« ãã‚Œä»¥å¤–', () => {
      const row = {
        'ç‰©ä»¶ç•ªå·': 'AA13501',
        'atbbæˆç´„æ¸ˆã¿/éå…¬é–‹': 'æˆç´„æ¸ˆã¿',
      };
      
      const result = service['calculateSidebarStatus'](row, gyomuListData);
      expect(result).toBe('');
    });
  });
});
```

### 7.2 çµ±åˆãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/api/test/property-sidebar-status.integration.test.ts`

```typescript
describe('Property Sidebar Status Integration', () => {
  test('åŒæœŸå¾Œã«sidebar_statusãŒä¿å­˜ã•ã‚Œã‚‹', async () => {
    // 1. åŒæœŸã‚’å®Ÿè¡Œ
    const service = getPropertyListingSyncService();
    await service.initialize();
    const result = await service.runFullSync('manual');
    
    expect(result.success).toBe(true);
    
    // 2. DBã‹ã‚‰å–å¾—
    const { data } = await supabase
      .from('property_listings')
      .select('property_number, sidebar_status')
      .limit(10);
    
    // 3. sidebar_statusãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(data).toBeDefined();
    expect(data!.length).toBeGreaterThan(0);
    expect(data![0].sidebar_status).toBeDefined();
  });
});
```

### 7.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/PropertySidebarStatus.test.tsx`

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { PropertySidebarStatus } from './PropertySidebarStatus';

describe('PropertySidebarStatus', () => {
  const mockProperties = [
    { id: 1, sidebar_status: 'æœªå ±å‘Š å±±æœ¬' },
    { id: 2, sidebar_status: 'æœªå ±å‘Š å±±æœ¬' },
    { id: 3, sidebar_status: 'æœªå®Œäº†' },
    { id: 4, sidebar_status: 'Yå°‚ä»»å…¬é–‹ä¸­' },
  ];
  
  test('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚Œã‚‹', () => {
    const onStatusSelect = jest.fn();
    
    render(
      <PropertySidebarStatus
        properties={mockProperties}
        selectedStatus={null}
        onStatusSelect={onStatusSelect}
      />
    );
    
    expect(screen.getByText('æœªå ±å‘Š å±±æœ¬ [2]')).toBeInTheDocument();
    expect(screen.getByText('æœªå®Œäº† [1]')).toBeInTheDocument();
    expect(screen.getByText('Yå°‚ä»»å…¬é–‹ä¸­ [1]')).toBeInTheDocument();
  });
  
  test('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã‚‹', () => {
    const onStatusSelect = jest.fn();
    
    render(
      <PropertySidebarStatus
        properties={mockProperties}
        selectedStatus={null}
        onStatusSelect={onStatusSelect}
      />
    );
    
    fireEvent.click(screen.getByText('æœªå ±å‘Š å±±æœ¬ [2]'));
    expect(onStatusSelect).toHaveBeenCalledWith('æœªå ±å‘Š å±±æœ¬');
  });
});
```

## 8. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 8.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```sql
-- 1. sidebar_statusã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE property_listings
ADD COLUMN sidebar_status TEXT;

-- 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
CREATE INDEX idx_property_listings_sidebar_status 
ON property_listings(sidebar_status);
```

### 8.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# 1. ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒŸãƒƒãƒˆ
git add backend/api/src/services/PropertyListingSyncService.ts
git commit -m "feat: Add sidebar status calculation to property sync"

# 2. ãƒ—ãƒƒã‚·ãƒ¥
git push origin main

# 3. Vercelã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
```

### 8.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# 1. ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒŸãƒƒãƒˆ
git add frontend/src/components/PropertySidebarStatus.tsx
git add frontend/src/pages/PropertyListPage.tsx
git commit -m "feat: Add property sidebar status filter"

# 2. ãƒ—ãƒƒã‚·ãƒ¥
git push origin main

# 3. Vercelã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
```

### 8.4 å‹•ä½œç¢ºèª

1. **åŒæœŸã®ç¢ºèª**:
   - Vercel Dashboardã§æ¬¡å›ã®åŒæœŸãƒ­ã‚°ã‚’ç¢ºèª
   - `sidebar_status`ãŒè¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

2. **DBã®ç¢ºèª**:
   ```sql
   SELECT property_number, sidebar_status 
   FROM property_listings 
   LIMIT 10;
   ```

3. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç¢ºèª**:
   - ç‰©ä»¶ãƒªã‚¹ãƒˆç”»é¢ã‚’é–‹ã
   - ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   - ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

## 9. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 9.1 åŒæœŸå‡¦ç†ã®æœ€é©åŒ–

**ç¾åœ¨ã®å‡¦ç†æ™‚é–“**ï¼ˆ100ä»¶ï¼‰:
- ç‰©ä»¶ãƒªã‚¹ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿å–ã‚Š: 1-2ç§’
- æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆèª­ã¿å–ã‚Š: 1-2ç§’ï¼ˆ1å›ã®ã¿ï¼‰
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—: 0.001ç§’ Ã— 100ä»¶ = 0.1ç§’
- DBä¿å­˜: 0.1ç§’ Ã— 100ä»¶ = 10ç§’
- **åˆè¨ˆ: ç´„12-14ç§’**

**æœ€é©åŒ–æ¡ˆ**:
1. ãƒãƒƒãƒä¿å­˜: 1ä»¶ãšã¤ã§ã¯ãªãã€10ä»¶ãšã¤ã¾ã¨ã‚ã¦ä¿å­˜
2. ä¸¦åˆ—å‡¦ç†: è¤‡æ•°ã®ç‰©ä»¶ã‚’ä¸¦åˆ—ã§å‡¦ç†ï¼ˆæ³¨æ„: APIã‚¯ã‚©ãƒ¼ã‚¿ï¼‰

### 9.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æœ€é©åŒ–

1. **ãƒ¡ãƒ¢åŒ–**: `useMemo`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¨ˆç®—
2. **ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«**: ç‰©ä»¶æ•°ãŒå¤šã„å ´åˆã¯ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨
3. **é…å»¶ãƒ­ãƒ¼ãƒ‰**: åˆå›ã¯æœ€åˆã®50ä»¶ã®ã¿è¡¨ç¤º

## 10. ä¿å®ˆæ€§

### 10.1 åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®å¤‰æ›´

**æ‰‹é †**:
1. `calculateSidebarStatus()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿®æ­£
2. å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ›´æ–°
3. ãƒ‡ãƒ—ãƒ­ã‚¤

**ä¾‹**: æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ 
```typescript
// â‘¬ æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè¿½åŠ ï¼‰
if (row['æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰'] === 'æ–°ã—ã„å€¤') {
  return 'æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹';
}
```

### 10.2 æ‹…å½“è€…ãƒãƒƒãƒ”ãƒ³ã‚°ã®å¤‰æ›´

**æ–¹æ³•1**: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´
```typescript
private loadStaffMapping(): Record<string, string> {
  return {
    'å±±æœ¬': 'Yå°‚ä»»å…¬é–‹ä¸­',
    'æ–°æ‹…å½“': 'æ–°ãƒ»å°‚ä»»å…¬é–‹ä¸­',  // â† è¿½åŠ 
  };
}
```

**æ–¹æ³•2**: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ï¼ˆæ¨å¥¨ï¼‰
```json
{
  "å±±æœ¬": "Yå°‚ä»»å…¬é–‹ä¸­",
  "æ–°æ‹…å½“": "æ–°ãƒ»å°‚ä»»å…¬é–‹ä¸­"
}
```

## 11. æ–°è¦ç‰©ä»¶ã®é…ä¿¡æ—¥åŒæœŸè¨­è¨ˆ

### 11.1 æ¦‚è¦

æ–°è¦ç‰©ä»¶è¿½åŠ æ™‚ã«ã€æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã€Œå…¬é–‹äºˆå®šæ—¥ã€ã‚’ç‰©ä»¶ãƒªã‚¹ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€Œé…ä¿¡æ—¥ã€å…¬é–‹ï¼‰ã€ã«æ›¸ãè¾¼ã‚€æ©Ÿèƒ½ã€‚

### 11.2 å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ syncNewProperties() - æ–°è¦ç‰©ä»¶è¿½åŠ å‡¦ç†                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ–°è¦ç‰©ä»¶ã‚’æ¤œå‡ºï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚ã‚‹ãŒDBã«ãªã„ï¼‰       â”‚
â”‚ 2. æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã‹ã‚‰ã€Œå…¬é–‹äºˆå®šæ—¥ã€ã‚’å–å¾—                  â”‚
â”‚ 3. ç‰©ä»¶ãƒªã‚¹ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€Œé…ä¿¡æ—¥ã€å…¬é–‹ï¼‰ã€ã«æ›¸ãè¾¼ã¿  â”‚
â”‚ 4. é€šå¸¸ã®åŒæœŸå‡¦ç†ã§distribution_dateãŒDBã«åæ˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3 å®Ÿè£…

#### 11.3.1 addNewProperty() ãƒ¡ã‚½ãƒƒãƒ‰ã®æ‹¡å¼µ

```typescript
/**
 * Add a new property to database
 * æ–°è¦ç‰©ä»¶è¿½åŠ æ™‚ã«é…ä¿¡æ—¥ã‚’æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã‹ã‚‰åŒæœŸ
 */
private async addNewProperty(
  spreadsheetRow: any,
  gyomuListData: any[]  // â† æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
): Promise<{ success: boolean; error?: string }> {
  try {
    const propertyNumber = String(spreadsheetRow['ç‰©ä»¶ç•ªå·'] || '').trim();
    if (!propertyNumber) {
      throw new Error('Property number is required');
    }

    // 1. æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã‹ã‚‰å…¬é–‹äºˆå®šæ—¥ã‚’å–å¾—
    const scheduledDate = this.lookupGyomuList(
      propertyNumber, 
      gyomuListData, 
      'å…¬é–‹äºˆå®šæ—¥'
    );

    // 2. å…¬é–‹äºˆå®šæ—¥ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
    if (scheduledDate) {
      try {
        await this.writeDistributionDateToSpreadsheet(
          propertyNumber, 
          scheduledDate
        );
        console.log(`âœ… Wrote distribution date for ${propertyNumber}: ${scheduledDate}`);
      } catch (error: any) {
        // æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã®ã¿ï¼ˆå‡¦ç†ã¯ç¶™ç¶šï¼‰
        console.warn(`âš ï¸ Failed to write distribution date for ${propertyNumber}:`, error.message);
      }
    }

    // 3. é€šå¸¸ã®ç‰©ä»¶è¿½åŠ å‡¦ç†ï¼ˆæ—¢å­˜ï¼‰
    const propertyData = this.columnMapper.mapSpreadsheetToDatabase(spreadsheetRow);
    propertyData.created_at = new Date().toISOString();
    propertyData.updated_at = new Date().toISOString();

    const { error: insertError } = await this.supabase
      .from('property_listings')
      .insert(propertyData);

    if (insertError) {
      throw new Error(insertError.message);
    }

    return { success: true };

  } catch (error: any) {
    return {
      success: false,
      error: error.message || 'Unknown error'
    };
  }
}
```

#### 11.3.2 writeDistributionDateToSpreadsheet() ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆæ–°è¦ï¼‰

```typescript
/**
 * ç‰©ä»¶ãƒªã‚¹ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œé…ä¿¡æ—¥ã€å…¬é–‹ï¼‰ã€åˆ—ã«æ›¸ãè¾¼ã¿
 * 
 * @param propertyNumber ç‰©ä»¶ç•ªå·
 * @param distributionDate é…ä¿¡æ—¥ï¼ˆå…¬é–‹äºˆå®šæ—¥ï¼‰
 */
private async writeDistributionDateToSpreadsheet(
  propertyNumber: string,
  distributionDate: any
): Promise<void> {
  if (!this.sheetsClient) {
    throw new Error('GoogleSheetsClient not configured');
  }

  // 1. ç‰©ä»¶ç•ªå·ã®è¡Œã‚’æ¤œç´¢
  const allRows = await this.sheetsClient.readAll();
  const rowIndex = allRows.findIndex(
    row => String(row['ç‰©ä»¶ç•ªå·'] || '').trim() === propertyNumber
  );

  if (rowIndex === -1) {
    throw new Error(`Property ${propertyNumber} not found in spreadsheet`);
  }

  // 2. ã€Œé…ä¿¡æ—¥ã€å…¬é–‹ï¼‰ã€åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
  // æ³¨: ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰å–å¾—ï¼ˆä¾‹: "é…ä¿¡æ—¥ã€å…¬é–‹ï¼‰" â†’ åˆ—ç•ªå·ï¼‰
  const columnIndex = this.getColumnIndex('é…ä¿¡æ—¥ã€å…¬é–‹ï¼‰');

  // 3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
  await this.sheetsClient.updateCell(
    rowIndex + 2,  // +2: ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ + 0-indexed
    columnIndex,
    distributionDate
  );
}

/**
 * ã‚«ãƒ©ãƒ åã‹ã‚‰åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
 */
private getColumnIndex(columnName: string): number {
  // ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰å–å¾—
  // å®Ÿè£…ä¾‹: column-mapping.jsonã‹ã‚‰èª­ã¿å–ã‚Š
  const mapping = this.columnMapper.getColumnMapping();
  return mapping[columnName] || -1;
}
```

#### 11.3.3 syncNewProperties() ãƒ¡ã‚½ãƒƒãƒ‰ã®å¤‰æ›´

```typescript
async syncNewProperties(): Promise<{
  total: number;
  added: number;
  failed: number;
  duration_ms: number;
}> {
  const startTime = Date.now();

  try {
    console.log('ğŸ†• Starting new property addition sync...');

    // 1. æ–°è¦ç‰©ä»¶ã‚’æ¤œå‡º
    const newPropertyNumbers = await this.detectNewProperties();

    if (newPropertyNumbers.length === 0) {
      console.log('âœ… No new properties detected');
      return {
        total: 0,
        added: 0,
        failed: 0,
        duration_ms: Date.now() - startTime
      };
    }

    console.log(`ğŸ“Š Detected ${newPropertyNumbers.length} new properties`);

    // 2. æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã‚’èª­ã¿å–ã‚Šï¼ˆé…ä¿¡æ—¥åŒæœŸç”¨ï¼‰
    let gyomuListData: any[] = [];
    try {
      const gyomuListSpreadsheetId = process.env.GYOMU_LIST_SPREADSHEET_ID;
      const gyomuListSheetName = process.env.GYOMU_LIST_SHEET_NAME || 'æ¥­å‹™ä¾é ¼';
      
      if (gyomuListSpreadsheetId) {
        const { GoogleSheetsClient } = await import('./GoogleSheetsClient');
        const gyomuListClient = new GoogleSheetsClient({
          spreadsheetId: gyomuListSpreadsheetId,
          sheetName: gyomuListSheetName,
          serviceAccountKeyPath: process.env.GOOGLE_SERVICE_ACCOUNT_KEY_PATH || './google-service-account.json',
        });
        await gyomuListClient.authenticate();
        gyomuListData = await gyomuListClient.readAll();
        console.log(`âœ… Fetched ${gyomuListData.length} rows from gyomu list`);
      }
    } catch (error: any) {
      console.warn('âš ï¸ Failed to fetch gyomu list data:', error.message);
      // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼ˆé…ä¿¡æ—¥åŒæœŸã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    }

    // 3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const spreadsheetData = await this.sheetsClient!.readAll();
    const spreadsheetMap = new Map(
      spreadsheetData.map(row => [
        String(row['ç‰©ä»¶ç•ªå·'] || '').trim(),
        row
      ])
    );

    // 4. å„ç‰©ä»¶ã‚’å‡¦ç†
    let added = 0;
    let failed = 0;
    const errors: Array<{ property_number: string; error: string }> = [];

    for (const propertyNumber of newPropertyNumbers) {
      const spreadsheetRow = spreadsheetMap.get(propertyNumber);
      
      if (!spreadsheetRow) {
        failed++;
        errors.push({
          property_number: propertyNumber,
          error: 'Spreadsheet data not found'
        });
        continue;
      }

      // æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
      const result = await this.addNewProperty(spreadsheetRow, gyomuListData);

      if (result.success) {
        added++;
        console.log(`  âœ… ${propertyNumber}: Added`);
      } else {
        failed++;
        errors.push({
          property_number: propertyNumber,
          error: result.error || 'Unknown error'
        });
        console.log(`  âŒ ${propertyNumber}: ${result.error}`);
      }
    }

    // 5. ã‚µãƒãƒªãƒ¼ã‚’è¿”ã™
    return {
      total: newPropertyNumbers.length,
      added,
      failed,
      duration_ms: Date.now() - startTime,
      errors: errors.length > 0 ? errors : undefined
    };

  } catch (error: any) {
    console.error('âŒ Sync failed:', error.message);
    throw error;
  }
}
```

### 11.4 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

1. **æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆèª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼**: è­¦å‘Šãƒ­ã‚°ã®ã¿ã€å‡¦ç†ã¯ç¶™ç¶šï¼ˆé…ä¿¡æ—¥åŒæœŸã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
2. **ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼**: è­¦å‘Šãƒ­ã‚°ã®ã¿ã€å‡¦ç†ã¯ç¶™ç¶šï¼ˆç‰©ä»¶è¿½åŠ ã¯å®Ÿè¡Œï¼‰
3. **ç‰©ä»¶è¿½åŠ ã‚¨ãƒ©ãƒ¼**: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¨˜éŒ²ã€æ¬¡ã®ç‰©ä»¶ã¸

### 11.5 åˆ¶ç´„äº‹é …

- **æ–°è¦ç‰©ä»¶ã®ã¿**: æ—¢å­˜ç‰©ä»¶ã®é…ä¿¡æ—¥ã¯å¤‰æ›´ã—ãªã„
- **å…¬é–‹äºˆå®šæ—¥ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿**: æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã«å…¬é–‹äºˆå®šæ—¥ãŒãªã„å ´åˆã¯æ›¸ãè¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—
- **éåŒæœŸå‡¦ç†**: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ã¯éåŒæœŸã§å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†ã¯ç¶™ç¶šï¼‰

## 12. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 11.1 sidebar_statusãŒç©ºæ–‡å­—ã«ãªã‚‹

**åŸå› **: åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®ã©ã®æ¡ä»¶ã«ã‚‚è©²å½“ã—ãªã„

**ç¢ºèªæ–¹æ³•**:
```sql
SELECT property_number, atbb_status, sidebar_status
FROM property_listings
WHERE sidebar_status = '' OR sidebar_status IS NULL
LIMIT 10;
```

**å¯¾å‡¦æ³•**: è©²å½“ç‰©ä»¶ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª

### 11.2 åŒæœŸãŒé…ã„

**åŸå› **: æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã®èª­ã¿å–ã‚ŠãŒé…ã„

**ç¢ºèªæ–¹æ³•**: Vercel Dashboardã®ãƒ­ã‚°ã‚’ç¢ºèª

**å¯¾å‡¦æ³•**: 
1. æ¥­å‹™ä¾é ¼ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿é‡ã‚’ç¢ºèª
2. ä¸è¦ãªè¡Œã‚’å‰Šé™¤
3. ãƒãƒƒãƒå‡¦ç†ã‚’æ¤œè¨

### 11.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› **: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«`sidebar_status`ãŒå«ã¾ã‚Œã¦ã„ãªã„

**ç¢ºèªæ–¹æ³•**:
```bash
curl https://your-api.vercel.app/api/properties | jq '.[0].sidebar_status'
```

**å¯¾å‡¦æ³•**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®SELECTã‚¯ã‚¨ãƒªã‚’ç¢ºèª

## 12. æ­£ç¢ºæ€§ã®ä¿è¨¼ï¼ˆCorrectness Propertiesï¼‰

### 12.1 Property 1: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ä¸€æ„æ€§

**ä»•æ§˜**: å„ç‰©ä»¶ã¯æœ€å¤§1ã¤ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æŒã¤

**æ¤œè¨¼æ–¹æ³•**:
```typescript
test('å„ç‰©ä»¶ã¯æœ€å¤§1ã¤ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æŒã¤', () => {
  const row = { /* ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ */ };
  const status = service['calculateSidebarStatus'](row, gyomuListData);
  
  // ç©ºæ–‡å­—ã¾ãŸã¯éç©ºæ–‡å­—åˆ—
  expect(typeof status).toBe('string');
});
```

### 12.2 Property 2: å„ªå…ˆé †ä½ã®ä¿è¨¼

**ä»•æ§˜**: è¤‡æ•°ã®æ¡ä»¶ã«è©²å½“ã™ã‚‹å ´åˆã€å„ªå…ˆé †ä½ã®é«˜ã„æ–¹ãŒé¸ã°ã‚Œã‚‹

**æ¤œè¨¼æ–¹æ³•**:
```typescript
test('æœªå ±å‘Šã¯æœªå®Œäº†ã‚ˆã‚Šå„ªå…ˆã•ã‚Œã‚‹', () => {
  const row = {
    'å ±å‘Šæ—¥': '2026-02-11',
    'å ±å‘Šæ‹…å½“': 'å±±æœ¬',
    'ç¢ºèª': 'æœª',  // æœªå®Œäº†ã®æ¡ä»¶ã‚‚æº€ãŸã™
  };
  
  const status = service['calculateSidebarStatus'](row, gyomuListData);
  expect(status).toBe('æœªå ±å‘Š å±±æœ¬');  // æœªå ±å‘ŠãŒå„ªå…ˆ
});
```

### 12.3 Property 3: æ—¥ä»˜æ¯”è¼ƒã®æ­£ç¢ºæ€§

**ä»•æ§˜**: æ—¥ä»˜æ¯”è¼ƒã¯æ­£ç¢ºã«è¡Œã‚ã‚Œã‚‹ï¼ˆã‚·ãƒªã‚¢ãƒ«å€¤å¯¾å¿œï¼‰

**æ¤œè¨¼æ–¹æ³•**:
```typescript
test('ã‚·ãƒªã‚¢ãƒ«å€¤ã®æ—¥ä»˜ã‚’æ­£ã—ãæ¯”è¼ƒ', () => {
  const row = {
    'å ±å‘Šæ—¥': 44952,  // 2026-02-11ã®ã‚·ãƒªã‚¢ãƒ«å€¤
    'å ±å‘Šæ‹…å½“': 'å±±æœ¬',
  };
  
  const status = service['calculateSidebarStatus'](row, gyomuListData);
  expect(status).toContain('æœªå ±å‘Š');
});
```

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2026å¹´2æœˆ12æ—¥  
**ä½œæˆè€…**: Kiro AI  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹**: åˆç¨¿
