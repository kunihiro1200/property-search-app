# 物件リスト：サイドバーカテゴリー ステータス判定仕様

## 1. 概要

物件リストのサイドバーに表示されるカテゴリーステータスを、スプレッドシートの複数のカラムから判定して表示する機能を実装します。

## 2. 背景

現在、物件リストのサイドバーには物件のカテゴリーが表示されていますが、スプレッドシートに定義されている詳細な判定ロジックが実装されていません。この判定ロジックは、報告日、確認状況、公開ステータス、買付状況など、複数の条件を組み合わせて優先順位に従って評価する必要があります。

## 3. 目標

スプレッドシートで定義されているサイドバーステータス判定ロジックを、バックエンドAPIとフロントエンドに実装し、物件リストのサイドバーに正確なステータスを表示できるようにします。

## 4. 要件

### 4.1 ステータス判定ルール

以下の順序で条件を評価し、最初に一致した条件のステータスを表示します。一致しなければ空文字を返します。

#### 4.1.1 未報告（最優先）
- **条件**: `報告日`が空白でない AND `報告日` <= 今日
- **表示**: "未報告" + 報告担当者名
  - 報告担当者名は`報告担当_override`が空白でなければそれを使用、空白なら`報告担当`を使用

#### 4.1.2 未完了
- **条件**: `確認` = "未"
- **表示**: "未完了"

#### 4.1.3 非公開予定（確認後）
- **条件**: `一般媒介非公開（仮）` = "非公開予定"
- **表示**: "非公開予定（確認後）"

#### 4.1.4 一般媒介の掲載確認未
- **条件**: `１社掲載` = "未確認"
- **表示**: "一般媒介の掲載確認未"

#### 4.1.5 本日公開予定
- **条件**: 
  - `atbb成約済み/非公開`に"公開前"が含まれる
  - AND 業務依頼シートの`公開予定日`が空白でない
  - AND 業務依頼シートの`公開予定日` <= 今日
- **表示**: "本日公開予定"

#### 4.1.6 SUUMO / レインズ登録必要
- **条件**:
  - (`atbb成約済み/非公開` = "一般・公開中" OR `atbb成約済み/非公開` = "専任・公開中")
  - AND 業務依頼シートの`公開予定日`が空白でない
  - AND 業務依頼シートの`公開予定日` <= 今日 - 1日
  - AND `Suumo URL`が空白
  - AND `Suumo登録` <> "S不要"
- **表示**:
  - `atbb成約済み/非公開` = "一般・公開中"の場合: "SUUMO URL　要登録"
  - それ以外: "レインズ登録＋SUUMO登録"

#### 4.1.7 買付申込み（内覧なし）２
- **条件**: 以下のいずれかに該当
  - (`買付` = "専任片手" AND `atbb成約済み/非公開` = "専任・公開中")
  - OR (`買付` = "一般他決" AND `atbb成約済み/非公開` = "一般・公開中")
  - OR (`買付` = "専任両手" AND `atbb成約済み/非公開` = "専任・公開中")
  - OR (`買付` = "一般両手" AND `atbb成約済み/非公開` = "一般・公開中")
  - OR (`買付` = "一般片手" AND `atbb成約済み/非公開` = "一般・公開中")
- **表示**: "買付申込み（内覧なし）２"

#### 4.1.8 公開前情報
- **条件**: 
  - `atbb成約済み/非公開` = "一般・公開前"
  - OR `atbb成約済み/非公開` = "専任・公開前"
- **表示**: "公開前情報"

#### 4.1.9 非公開（配信メールのみ）
- **条件**: `atbb成約済み/非公開` = "非公開（配信メールのみ）"
- **表示**: "非公開（配信メールのみ）"

#### 4.1.10 一般公開中物件
- **条件**: `atbb成約済み/非公開` = "一般・公開中"
- **表示**: "一般公開中物件"

#### 4.1.11 専任・公開中（担当別）
- **条件**: `atbb成約済み/非公開` = "専任・公開中"
- **表示**: 担当名に応じて以下を表示
  - "山本" → "Y専任公開中"
  - "生野" → "生・専任公開中"
  - "久" → "久・専任公開中"
  - "裏" → "U専任公開中"
  - "林" → "林・専任公開中"
  - "国広" → "K専任公開中"
  - "木村" → "R専任公開中"
  - "角井" → "I専任公開中"

#### 4.1.12 それ以外
- **表示**: ""（空文字）

### 4.2 必要なデータソース

#### 4.2.1 物件リストスプレッドシート
- `物件番号`
- `atbb成約済み/非公開`
- `報告日`
- `報告担当`
- `報告担当_override`
- `確認`
- `一般媒介非公開（仮）`
- `１社掲載`
- `Suumo URL`
- `Suumo登録`
- `買付`
- `担当名（営業）`

#### 4.2.2 業務依頼シート
- `物件番号`
- `公開予定日`

### 4.3 実装要件

#### 4.3.1 バックエンド

**データベーススキーマ**:
- `property_listings`テーブルに`sidebar_status`カラム（TEXT型）を追加

**同期処理の拡張**（`PropertyListingSyncService.runFullSync()`）:
1. 物件リストスプレッドシートから必要なカラムを取得（既存処理）
2. 業務依頼シートを**1回だけ**読み取り、メモリに保持
3. 各物件の処理時に：
   - 判定ロジック（`calculateSidebarStatus()`メソッド）を実行
   - 計算結果を`sidebar_status`フィールドに設定
   - DBに保存（既存のupsert処理に統合）

**判定ロジックの実装**:
- `calculateSidebarStatus(row, gyomuListData)`メソッドを新規作成
- 12個の判定ルールを優先順位順に評価
- 業務依頼シートのデータは引数で受け取る（LOOKUP相当の処理）
- 担当者名マッピングは設定ファイル化を検討（`config/staff-mapping.json`）

**パフォーマンス最適化**:
- 業務依頼シートは同期開始時に1回だけ読み取り
- 全物件の処理で同じデータを再利用
- キャッシュ機構は不要（同期中のみメモリに保持）

#### 4.3.2 フロントエンド

**物件リスト画面のサイドバー**:
- 既存のフィルター（買主フィルター等）を削除
- 新しいステータスカテゴリーセクションに置き換え
- `sidebar_status`をカテゴリーとしてグループ化して表示
- 各カテゴリーに物件数を表示（例: "未報告 (山本) [5]"）
- カテゴリークリックで該当物件のみをフィルタリング

**表示要件**:
- ステータスが空文字の物件は「その他」カテゴリーに表示
- ステータスに応じた色分けやアイコンの表示（オプション）

### 4.4 制約事項

- 既存の物件リスト同期処理を壊さないこと
- システム隔離ルールを遵守すること（物件リストシステムのみを変更）
- 後方互換性を保つこと（既存のAPIエンドポイントを変更しない）

## 5. 成功基準

- [ ] 物件リストスプレッドシートから必要なカラムを正しく取得できる
- [ ] 業務依頼シートから`公開予定日`を正しく取得できる
- [ ] 12個の判定ルールが正しい優先順位で評価される
- [ ] 計算されたステータスが`property_listings`テーブルに保存される
- [ ] フロントエンドのサイドバーに正しいステータスが表示される
- [ ] 既存の物件リスト機能が正常に動作し続ける

## 6. 非機能要件

### 6.1 パフォーマンス
- 既存の同期処理の実行時間を大幅に増加させないこと
- 目標: ステータス計算による追加時間は1秒以内（100件の物件）
- 業務依頼シートの読み取りは同期中に1回のみ

### 6.2 保守性
- 判定ロジックを変更しやすい構造にすること
- 各判定ルールを独立したメソッドまたは関数として実装
- 担当者名マッピングは設定ファイル化を検討

### 6.3 テスト可能性
- `calculateSidebarStatus()`メソッドを単体テスト可能にする
- 各判定ルールを個別にテストできること
- モックデータで全12パターンをテスト

## 7. 追加要件：新規物件の配信日同期

### 7.1 概要
新規物件を追加する際、業務依頼シートの「公開予定日」を物件リストスプレッドシートの「配信日【公開）」列に書き込む機能を実装します。

### 7.2 対象
- **新規追加の物件のみ**（`syncNewProperties()`で追加される物件）
- 既存の物件は対象外（物件リストスプレッドシート「配信日【公開）」から同期を継続）

### 7.3 処理フロー
1. 新規物件を検出（スプレッドシートにあるがDBにない物件）
2. 業務依頼シートから該当物件の「公開予定日」を取得
3. 物件リストスプレッドシートの「配信日【公開）」列に書き込み
4. 通常の同期処理で`distribution_date`がDBに反映される

### 7.4 実装要件
- `addNewProperty()`メソッドを拡張
- 業務依頼シートから「公開予定日」を取得（既存のgyomuListDataを再利用）
- GoogleSheetsClientを使用してスプレッドシートに書き込み
- エラーハンドリング：書き込み失敗時もログを記録して処理を継続

### 7.5 制約事項
- 既存物件の配信日は変更しない
- 業務依頼シートに「公開予定日」がない場合は書き込みをスキップ
- スプレッドシート書き込みエラーは警告ログのみ（処理は継続）

## 8. 除外事項

- サイドバーのUI/UXの大幅な変更
- 判定ルールの変更や追加（現在のスプレッドシート仕様に従う）
- 他のシステム（売主リスト、買主リスト等）への影響

## 8. 参考情報

### 8.1 関連ステアリングドキュメント
- `system-isolation-rule.md` - システム隔離ルール
- `property-listing-sync-rules.md` - 物件リスト同期ルール
- `property-listing-column-mapping.md` - カラムマッピング

### 8.2 関連ファイル
- `backend/api/src/services/PropertyListingSyncService.ts` - 物件リスト同期サービス
- `frontend/src/pages/PropertyListPage.tsx` - 物件リスト画面
- `frontend/src/components/PropertySidebar.tsx` - サイドバーコンポーネント（存在する場合）

## 9. 設計上の決定事項

### 9.1 ステータスの計算タイミング

**決定**: 物件リスト同期時に計算してDBに保存

**理由**:
1. 効率的: 同期時に1回だけ計算（追加コストはほぼゼロ）
2. シンプル: 既存の処理に統合するだけ
3. リアルタイム性: 15分ごとに更新（十分）
4. 業務依頼シートも1回読み取り: 既に読み取っているデータを再利用

**代替案（却下）**:
- 毎回計算: 遅い、複雑、業務依頼シート参照のコストが高い

### 9.2 業務依頼シートの読み取り

**決定**: 同期開始時に1回だけ読み取り、全物件で再利用

**理由**:
1. パフォーマンス: 100回の読み取り → 1回の読み取り（約10倍高速化）
2. APIクォータ節約: Google Sheets APIの呼び出し回数を削減
3. シンプル: キャッシュ機構不要

**実装**:
```typescript
// 同期開始時に1回だけ読み取る
const gyomuListData = await this.gyomuListSheetsClient.readAll();

// 各物件の処理で再利用
for (const row of rows) {
  const status = this.calculateSidebarStatus(row, gyomuListData);
}
```

### 9.3 フロントエンドの表示

**決定**: サイドバーを総入れ替え

**変更内容**:
- 現在の買主フィルターなどを削除
- 新しいステータスカテゴリーに置き換え

**表示イメージ**:
```
┌─────────────────────┐
│ 物件ステータス      │
├─────────────────────┤
│ 未報告 (山本) [5]   │
│ 未完了 [3]          │
│ 本日公開予定 [2]    │
│ Y専任公開中 [12]    │
│ 一般公開中物件 [8]  │
│ その他 [15]         │
└─────────────────────┘
```

### 9.4 判定ロジックの保守性

**決定**: ハードコード（一部設定ファイル化）

**理由**:
1. 判定ロジックは複雑（LOOKUP、日付比較、複数条件のOR等）
2. 変更頻度は低い（月1回程度）
3. 設定ファイル化のコストが高い

**例外**: 担当者名マッピング（⑪）のみ設定ファイル化を検討

**設定ファイル例**（`config/staff-mapping.json`）:
```json
{
  "山本": "Y専任公開中",
  "生野": "生・専任公開中",
  "久": "久・専任公開中",
  "裏": "U専任公開中",
  "林": "林・専任公開中",
  "国広": "K専任公開中",
  "木村": "R専任公開中",
  "角井": "I専任公開中"
}
```

### 9.5 パフォーマンス見積もり

**現在の処理時間**（100件の物件）:
- 物件リストスプレッドシート読み取り: 1-2秒
- 業務依頼シート読み取り: 1-2秒 × 100回 = 100-200秒
- DB保存: 0.1秒 × 100件 = 10秒
- **合計: 約111-212秒**

**改善後の処理時間**:
- 物件リストスプレッドシート読み取り: 1-2秒
- 業務依頼シート読み取り: 1-2秒（**1回だけ**）
- ステータス計算: 0.001秒 × 100件 = 0.1秒
- DB保存: 0.1秒 × 100件 = 10秒
- **合計: 約12-14秒**

**改善効果**: 約10倍高速化

---

## 10. 質問・懸念事項（解決済み）

### ~~1. データベーススキーマ~~
**解決**: 同期時に計算してDBに保存

### ~~2. 業務依頼シートの参照~~
**解決**: 同期開始時に1回だけ読み取り、全物件で再利用

### ~~3. フロントエンドの表示場所~~
**解決**: サイドバーを総入れ替え

### ~~4. 判定ロジックの保守性~~
**解決**: ハードコード（担当者マッピングのみ設定ファイル化）
