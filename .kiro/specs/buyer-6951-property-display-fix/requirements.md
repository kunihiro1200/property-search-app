# 買主6951の物件情報表示とサイドバーステータス修正

## 概要

買主6951において、以下の2つの問題を修正します：
1. 物件情報が表示されない問題
2. サイドバーステータスが正しく表示されない問題

## 背景

### 問題1: 物件情報が表示されない

**症状**:
- 買主6951をクリックすると「物件情報はありません」と表示される
- しかし、AA1949と紐づいているはず

**根本原因**:
- `BuyerService.getLinkedProperties()`メソッドが`buyer_id`で買主を検索している
- しかし、ステアリングドキュメント（`buyer-table-column-definition.md`）によると：
  - ✅ **`buyer_number`が主キー**
  - ❌ **`buyer_id`は存在すら不要**（データベースに存在しても、アプリケーションでは完全に無視する）

**影響範囲**:
- `backend/src/services/BuyerService.ts`の`getLinkedProperties()`メソッド
- `backend/src/routes/buyers.ts`の`GET /:id/properties`エンドポイント

### 問題2: サイドバーステータスが正しく表示されない

**症状**:
- 「業者向けアンケート」カラムが「未」
- しかし、サイドバーステータスが「業者問合せあり」にならない

**期待される動作**:
- 「業者向けアンケート」カラムが「未」の場合、サイドバーに「業者問合せあり」カテゴリとして表示されるべき

**調査が必要**:
- サイドバーステータスの判定ロジックを確認
- 「業者問合せあり」カテゴリの条件を確認

## 要件

### 1. 物件情報表示の修正

#### 1.1 `getLinkedProperties`メソッドの修正

**要件**:
- `buyer_id`ではなく`buyer_number`で買主を検索する
- `buyer_id`を完全に無視する

**変更箇所**:
- `backend/src/services/BuyerService.ts`の`getLinkedProperties()`メソッド

**期待される動作**:
- 買主番号（例: "6951"）を受け取る
- `buyers`テーブルから`buyer_number`で検索
- `property_number`フィールドから物件番号を取得
- `property_listings`テーブルから物件情報を取得
- 物件情報を返す

#### 1.2 APIエンドポイントの修正

**要件**:
- `GET /api/buyers/:id/properties`エンドポイントを修正
- `:id`パラメータを`buyer_number`として扱う
- `buyer_id`への変換を削除

**変更箇所**:
- `backend/src/routes/buyers.ts`の`GET /:id/properties`エンドポイント

**期待される動作**:
- `/api/buyers/6951/properties`にアクセス
- 買主番号"6951"で直接検索
- 物件情報を返す

### 2. サイドバーステータスの修正

#### 2.1 「業者問合せあり」カテゴリの条件確認

**要件**:
- 「業者向けアンケート」カラムが「未」の場合、「業者問合せあり」カテゴリに表示される
- サイドバーステータスの判定ロジックを確認

**調査箇所**:
- `frontend/src/utils/sellerStatusFilters.ts`（売主用だが、買主にも同様のロジックがあるはず）
- `frontend/src/components/BuyerStatusSidebar.tsx`（存在する場合）
- `frontend/src/pages/BuyerListPage.tsx`

**期待される動作**:
- 買主6951が「業者問合せあり」カテゴリに表示される
- サイドバーの件数が正しく表示される

## 受け入れ基準

### 1. 物件情報表示

- [ ] 買主6951をクリックすると、AA1949の物件情報が表示される
- [ ] 物件詳細カードに以下の情報が表示される：
  - 物件番号: AA1949
  - 住所
  - 種別
  - 価格
  - その他の物件情報

### 2. サイドバーステータス

- [ ] 買主6951が「業者問合せあり」カテゴリに表示される
- [ ] サイドバーの「業者問合せあり」の件数が正しく表示される
- [ ] 「業者問合せあり」カテゴリをクリックすると、買主6951が一覧に表示される

### 3. 後方互換性

- [ ] 他の買主の物件情報表示に影響がない
- [ ] 他の買主のサイドバーステータス表示に影響がない
- [ ] 既存のAPIエンドポイントが正常に動作する

## 技術的制約

### 1. buyer_idの扱い

**絶対に守るべきルール**（`buyer-table-column-definition.md`より）:
- ✅ **`buyer_number`が主キー**
- ❌ **`buyer_id`は存在すら不要**（データベースに存在しても、アプリケーションでは完全に無視する）
- ❌ **`id`カラムは存在しない**（絶対に使用しない）

### 2. 物件紐づけのルール

**物件紐づけの条件**（`buyer-property-card-sync-rule.md`より）:
- `buyers.property_number`フィールドに物件番号が入っている
- カンマ区切りで複数の物件番号が入っている場合もある
- `inquiry_history`テーブルは存在しない

### 3. システム隔離ルール

**絶対に守るべきルール**（`system-isolation-rule.md`より）:
- 買主リストシステムのファイルのみを変更する
- 売主リスト、物件リスト、物件公開サイトには影響を与えない

## 関連ドキュメント

- `.kiro/steering/buyer-table-column-definition.md` - 買主テーブルのカラム定義
- `.kiro/steering/buyer-property-card-sync-rule.md` - 物件詳細カード同期ルール
- `.kiro/steering/system-isolation-rule.md` - システム隔離ルール

## 次のステップ

1. 買主6951のデータを確認（`property_number`フィールドの値）
2. `getLinkedProperties`メソッドを修正
3. APIエンドポイントを修正
4. サイドバーステータスの判定ロジックを確認
5. 「業者問合せあり」カテゴリの条件を修正（必要な場合）
6. テストを実行
7. ブラウザで動作確認
