---
inclusion: auto
---

# ローカル環境保護ルール（絶対に守るべきルール）

## ⚠️ 最重要：ローカル環境は絶対に壊さない

**絶対に守るべき原則**:
- **ローカル環境では売主、買主、物件、業務リストが全て正常に動作している**
- **ローカル環境のコードは本番環境でもそのまま使用する**
- **万が一本番環境で問題が発生した場合、即座にローカル環境に戻せるようにする**
- **ローカル環境のコードは絶対に変更しない**

---

## 📊 ローカル環境の現状

### ✅ 正常に動作しているシステム

1. **売主リスト**
   - スプレッドシートと同期
   - データの読み取り・書き込みが正常
   - 追客機能が正常

2. **買主リスト**
   - スプレッドシートと同期
   - データの読み取り・書き込みが正常
   - 問い合わせ対応が正常

3. **物件リスト**
   - スプレッドシートと同期
   - データの読み取り・書き込みが正常
   - 物件詳細が正常

4. **業務リスト**
   - スプレッドシートと同期
   - データの読み取り・書き込みが正常
   - タスク管理が正常

5. **共有リスト**
   - スプレッドシートと同期
   - データの読み取り・書き込みが正常

---

## 🚨 絶対に守るべきルール

### ルール1: ローカル環境のコードは変更しない

**対象ファイル**:
- `backend/src/` ディレクトリ配下の全てのファイル
- `backend/api/main.ts`
- `frontend/src/` ディレクトリ配下の全てのファイル

**理由**:
- ローカル環境で正常に動作している
- 本番環境でもこのコードをそのまま使用する
- 変更すると動作しなくなるリスクがある

### ルール2: 本番環境移行は新しいプロジェクトで行う

**方針**:
- `admin-backend`ディレクトリを作成（✅ 完了）
- `backend/src/`の全ファイルを`admin-backend/src/`にコピー（✅ 完了）
- 新しいVercelプロジェクト`admin-backend`を作成
- ローカル環境のコードは一切変更しない

**メリット**:
- ローカル環境は常に動作し続ける
- 本番環境で問題が発生しても、ローカル環境に影響しない
- いつでもローカル環境に戻せる

### ルール3: 即座にロールバックできるようにする

**ロールバック手順**:
1. Vercelダッシュボードで前のデプロイメントにロールバック
2. フロントエンドの環境変数をローカル環境のURLに戻す
3. ローカル環境で`npm run dev`を実行

**所要時間**: 1-2分

---

## 📋 本番環境移行の方針

### ステップ1: ローカル環境のコードをそのまま使用

- `admin-backend/src/`にコピー済み（✅ 完了）
- コードは一切変更しない
- 環境変数のみを本番環境用に設定

### ステップ2: 新しいVercelプロジェクトを作成

- プロジェクト名: `admin-backend`
- Root Directory: `admin-backend`
- ローカル環境とは完全に独立

### ステップ3: 環境変数を設定

- ローカル環境と同じ環境変数を設定
- `SUPABASE_URL`
- `SUPABASE_SERVICE_KEY`
- `GOOGLE_SERVICE_ACCOUNT_JSON`
- その他全ての環境変数

### ステップ4: デプロイして動作確認

- `/api/health`エンドポイントが正常に動作するか確認
- データが正しく表示されるか確認
- スプレッドシートとの同期が正常に動作するか確認

### ステップ5: 問題が発生した場合

- **即座にロールバック**
- ローカル環境に戻す
- 問題を特定して修正
- 再度デプロイ

---

## 🔒 ローカル環境の保護

### 保護対象

1. **`backend/src/`ディレクトリ**
   - 全てのサービスファイル
   - 全てのルートファイル
   - 全ての設定ファイル

2. **`backend/api/main.ts`**
   - 業務管理システムのエントリーポイント

3. **`frontend/src/`ディレクトリ**
   - 全てのページファイル
   - 全てのコンポーネントファイル

4. **環境変数**
   - `.env.local`ファイル
   - ローカル環境の設定

### 保護方法

1. **コードは一切変更しない**
   - `admin-backend/src/`にコピーして使用
   - オリジナルの`backend/src/`は変更しない

2. **Gitで管理**
   - 変更前のコミットを記録
   - いつでも戻せるようにする

3. **ロールバック手順を用意**
   - Vercelでロールバック
   - ローカル環境に戻す手順を明確にする

---

## 🎯 ロールバック手順（詳細）

### 方法1: Vercelでロールバック（推奨）

1. **Vercelダッシュボードにアクセス**
   - https://vercel.com/dashboard
   - `admin-backend`プロジェクトを選択

2. **Deploymentsタブに移動**
   - 前のデプロイメントを選択
   - "..." メニューから "Promote to Production" をクリック

3. **フロントエンドの環境変数を確認**
   - `new-admin-management-system`プロジェクトの環境変数
   - `VITE_API_URL`が正しいか確認

**所要時間**: 1-2分

### 方法2: ローカル環境に戻す

1. **フロントエンドの環境変数を変更**
   - `new-admin-management-system`プロジェクトの環境変数
   - `VITE_API_URL`を`http://localhost:3001`に変更

2. **ローカル環境を起動**
   ```bash
   # バックエンド
   cd backend
   npm run dev
   
   # フロントエンド（別のターミナル）
   cd frontend
   npm run dev
   ```

3. **動作確認**
   - `http://localhost:5173`にアクセス
   - 全てのシステムが正常に動作することを確認

**所要時間**: 2-3分

### 方法3: Gitでロールバック

```bash
# 現在のコミットを確認
git log --oneline

# 特定のコミットに戻す
git revert <commit-hash>

# または、特定のコミットまで戻す
git reset --hard <commit-hash>

# プッシュ
git push origin main --force
```

**注意**: `git reset --hard`は履歴を削除するため、慎重に使用してください。

---

## 📝 環境変数の管理

### ローカル環境

**ファイル**: `backend/.env.local`

**内容**:
```
SUPABASE_URL=<ローカル環境のURL>
SUPABASE_SERVICE_KEY=<ローカル環境のキー>
GOOGLE_SERVICE_ACCOUNT_JSON=<ローカル環境の認証情報>
...
```

### 本番環境

**場所**: Vercelダッシュボード → `admin-backend` → Settings → Environment Variables

**内容**:
- ローカル環境と同じ環境変数
- 値は本番環境用に設定

---

## ✅ チェックリスト

### 本番環境移行前

- [ ] ローカル環境が正常に動作しているか確認
- [ ] `admin-backend/src/`にコードがコピーされているか確認
- [ ] `backend/src/`は変更されていないか確認
- [ ] ロールバック手順を理解しているか確認

### 本番環境移行後

- [ ] `/api/health`エンドポイントが正常に動作するか確認
- [ ] データが正しく表示されるか確認
- [ ] スプレッドシートとの同期が正常に動作するか確認
- [ ] 問題が発生した場合、即座にロールバックできるか確認

### ロールバック後

- [ ] ローカル環境が正常に動作しているか確認
- [ ] 全てのシステムが正常に動作しているか確認
- [ ] 問題の原因を特定したか確認

---

## まとめ

**絶対に守るべきルール**:

1. **ローカル環境のコードは絶対に変更しない**
2. **本番環境移行は新しいプロジェクト（`admin-backend`）で行う**
3. **問題が発生した場合、即座にロールバックする**
4. **ローカル環境は常に動作し続けるようにする**
5. **ロールバック手順を常に用意しておく**

**このルールを徹底することで、ローカル環境を保護し、安全に本番環境に移行できます。**

---

**最終更新日**: 2026年2月18日  
**作成理由**: ローカル環境を保護し、安全に本番環境に移行するため  
**関連ドキュメント**: 
- `vercel-project-structure.md`
- `production-site-protection-rule.md`
- `.kiro/specs/production-environment-migration/current-status.md`
