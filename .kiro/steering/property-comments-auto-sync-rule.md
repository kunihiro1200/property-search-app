# 物件コメントデータ自動同期ルール（絶対に守るべきルール）

## ⚠️ 最重要：2つの同期の違い

### 1. 物件リスト同期（Phase 4.6）
**対象**: スプレッドシート「物件」シートに存在する**全ての物件**
- `atbb_status`の値に関係なく、全て同期
- `work_tasks`の有無に関係なく、全て同期
- **AA13527-2も対象**

### 2. コメント同期（Phase 4.7）
**対象**: 業務依頼シート（スプレッドシート）に`spreadsheet_url`が入っている物件のみ
- 個別物件スプレッドシートが存在する物件のみ
- `athome`シートからコメントデータを取得
- **AA13527-2も対象**（業務依頼シートにスプレッドシートURLが存在するため）
- **work_tasksテーブルへの依存を解消**（2026年2月3日修正）

---

## 📋 Phase 4.7: property_details同期（コメント同期）

**実装**: `EnhancedAutoSyncService.syncMissingPropertyDetails()`

**実行タイミング**: **5分ごと**の自動同期で実行

**対象物件**:
1. 業務依頼シート（スプレッドシート）に`spreadsheet_url`が入っている物件
2. `property_details`テーブルにコメントデータが空の物件

**処理内容**:
1. 業務依頼シートから物件番号と`spreadsheet_url`を取得（60分間キャッシュ）
2. これらの物件の`property_details`を確認
3. コメントデータが空の物件を検出
4. `AthomeSheetSyncService`を使用して個別物件スプレッドシートの`athome`シートから同期
5. バッチ処理（10件ずつ、3秒間隔）でAPIクォータを回避

**APIクォータ対策**:
- 業務依頼シートのデータを60分間キャッシュ
- Phase 4.7実行時に1回だけ業務依頼シートを読み取り
- 手動同期時はキャッシュを自動的にクリア

---

## 🚨 同期対象外の物件

以下の物件は自動同期の対象外：
- 業務依頼シート（スプレッドシート）に存在しない物件
- 業務依頼シートに存在するが、`spreadsheet_url`（D列）が空の物件

**理由**:
- `spreadsheet_url`がない物件は、個別物件スプレッドシートが存在しない
- 個別物件スプレッドシートがない場合、`athome`シートも存在しない
- `athome`シートがない場合、コメントデータを取得できない

---

## 📊 対象物件数の目安

**全物件数**: 約1,500件

**業務依頼シートにspreadsheet_urlがある物件**: 約150-200件

**自動同期対象（コメントデータが空）**: 約50-100件（初回のみ、以降は新規物件のみ）

**推定時間**: 約3-7分（1物件あたり2秒 × 50-100件）

**APIクォータ使用量**:
- 業務依頼シート読み取り: 1回/60分（キャッシュ）
- 個別物件スプレッドシート読み取り: 同期対象物件数分

---

## 🛠️ 手動同期（必要な場合のみ）

通常は自動同期で十分ですが、緊急時や大量の物件を一度に同期したい場合は手動で実行できます。

### 方法1: 全物件コメント同期スクリプト

```bash
# クォータ確認
npx ts-node backend/check-google-sheets-quota.ts

# 同期実行
npx ts-node backend/sync-all-property-comments.ts
```

### 方法2: 個別物件の同期

```typescript
import { AthomeSheetSyncService } from './src/services/AthomeSheetSyncService';

const athomeService = new AthomeSheetSyncService();
await athomeService.syncPropertyComments('AA13501', 'land');
```

---

## 📝 関連ファイル

| ファイル | 役割 |
|---------|------|
| `backend/src/services/EnhancedAutoSyncService.ts` | 自動同期サービス（Phase 4.6, 4.7を含む） |
| `backend/src/services/AthomeSheetSyncService.ts` | Athomeシート同期サービス |
| `backend/src/services/PropertyDetailsService.ts` | 物件詳細サービス |
| `backend/sync-all-property-comments.ts` | 全物件コメント同期スクリプト（手動実行用） |
| `backend/check-google-sheets-quota.ts` | Google Sheets APIクォータ確認スクリプト |

---

## ✅ チェックリスト

新規物件を追加する際は、以下を確認：

- [ ] `property_listings`テーブルに物件が追加されているか？（Phase 4.6で自動）
- [ ] コメント同期が必要な場合、業務依頼シート（スプレッドシート）に`spreadsheet_url`（D列）が登録されているか？
- [ ] 個別物件スプレッドシートに`athome`シートが存在するか？
- [ ] 自動同期が有効になっているか？（通常は有効）
- [ ] 5分以内に自動同期が実行されるのを待つ、または手動で同期を実行

---

## 🎯 AA13527-2の場合

### 現在の状況（修正後）
- ✅ `property_listings`テーブルに追加済み（Phase 4.6で同期）
- ✅ 業務依頼シートにスプレッドシートURL存在
- ✅ コメント同期の対象になる（Phase 4.7で自動同期）

### コメント同期の実行
- 次回の自動同期（5分以内）で自動的に実行される
- または手動で同期を実行可能

---

## まとめ

**物件リスト同期（Phase 4.6）**:
- スプレッドシート「物件」シートの**全ての物件**を同期
- `atbb_status`に関係なく同期
- `work_tasks`の有無に関係なく同期

**コメント同期（Phase 4.7）**:
- 業務依頼シート（スプレッドシート）に`spreadsheet_url`がある物件のみを同期
- 個別物件スプレッドシートの`athome`シートからコメントを取得
- **work_tasksテーブルへの依存を解消**（2026年2月3日修正）
- 業務依頼シートのデータを60分間キャッシュしてAPIクォータを節約

**このルールを徹底することで、無駄な同期処理を防ぎ、効率的にコメントデータを同期できます。**

---

**最終更新日**: 2026年2月3日  
**作成理由**: 全物件を同期しようとして時間がかかりすぎた問題を防ぐため  
**更新履歴**:
- 2026年2月3日: **work_tasksテーブルへの依存を解消**、業務依頼シートから直接スプレッドシートURLを取得するように修正、60分間キャッシュを追加
- 2026年2月3日: 物件リスト同期とコメント同期の違いを明確化、AA13527-2の状況を追加
- 2026年2月2日: Phase 4.7の自動同期を再有効化、work_tasksフィルターを追加
