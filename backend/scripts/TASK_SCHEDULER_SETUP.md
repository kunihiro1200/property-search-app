# Windowsタスクスケジューラ設定ガイド

## 概要

PCが起動している間、自動的に同期を実行します。

- **軽量同期**: 10分ごと（新規追加 + 「追客中」売主の更新）
- **フル同期**: 1日2回（全データ同期）

---

## 軽量同期の機能

1. **新規売主の追加**: 最後の20行から新規売主を検出
2. **「追客中」売主の更新**: 全行から「追客中」をフィルタリングしてDBと比較・更新

### 同期対象フィールド
- 査定額（手動入力優先）
- 営担
- 次電日
- 電話担当
- 連絡取りやすい時間
- 連絡方法
- Pinrich
- 不通

### Google Sheets APIクォータ対策
- スプレッドシートデータは**30分間キャッシュ**
- 「追客中」の売主のみを同期対象にすることでDB更新を最小化

---

## 設定手順

### 1. タスクスケジューラを開く

**方法1**: 
1. `Win + R` を押す
2. `taskschd.msc` と入力してEnter

**方法2**:
1. スタートメニューを開く
2. 「タスク スケジューラ」と検索
3. 「タスク スケジューラ」をクリック

---

### 2. 軽量同期タスクを作成

1. 右側の「タスクの作成」をクリック

#### 全般タブ
- **名前**: `売主リスト軽量同期`
- **説明**: `10分ごとに新規売主の追加と「追客中」売主の更新を実行`
- **セキュリティオプション**: 「ユーザーがログオンしているときのみ実行する」を選択

#### トリガータブ
1. 「新規」をクリック
2. **タスクの開始**: `スケジュールに従う`
3. **設定**: `毎日`
4. **開始**: `2026/02/01 08:00:00`
5. **詳細設定**:
   - ✅ 「繰り返し間隔」: `10分間`
   - 「継続時間」: `無期限`
6. 「OK」をクリック

#### 操作タブ
1. 「新規」をクリック
2. **操作**: `プログラムの開始`
3. **プログラム/スクリプト**: `C:\Users\kunih\sateituikyaku\backend\scripts\run-light-sync.bat`
4. 「OK」をクリック

#### 条件タブ
- ✅ 「コンピューターをAC電源で使用している場合のみタスクを開始する」のチェックを外す
- ✅ 「コンピューターがアイドル状態の場合のみタスクを開始する」のチェックを外す

#### 設定タブ
- ✅ 「タスクを要求時に実行する」
- ✅ 「スケジュールされた時刻にタスクを開始できなかった場合、すぐにタスクを実行する」
- 「タスクが既に実行中の場合に適用される規則」: `新しいインスタンスを開始しない`

5. 「OK」をクリックして保存

---

### 3. フル同期タスクを作成

1. 右側の「タスクの作成」をクリック

#### 全般タブ
- **名前**: `売主リストフル同期`
- **説明**: `1日2回、全売主データを同期`

#### トリガータブ（2つ作成）

**トリガー1: 朝**
1. 「新規」をクリック
2. **タスクの開始**: `スケジュールに従う`
3. **設定**: `毎日`
4. **開始**: `2026/02/01 08:00:00`
5. 「OK」をクリック

**トリガー2: 夕方**
1. 「新規」をクリック
2. **タスクの開始**: `スケジュールに従う`
3. **設定**: `毎日`
4. **開始**: `2026/02/01 18:00:00`
5. 「OK」をクリック

#### 操作タブ
1. 「新規」をクリック
2. **操作**: `プログラムの開始`
3. **プログラム/スクリプト**: `C:\Users\kunih\sateituikyaku\backend\scripts\run-full-sync.bat`
4. 「OK」をクリック

5. 「OK」をクリックして保存

---

## ログの確認

同期ログは以下のファイルに出力されます：

- **軽量同期**: `backend/logs/light-sync.log`
- **フル同期**: `backend/logs/full-sync.log`

```bash
# 最新のログを確認
type backend\logs\light-sync.log
```

---

## 手動実行

タスクを手動で実行するには：

1. タスクスケジューラでタスクを右クリック
2. 「実行」をクリック

または、コマンドラインから：

```bash
# 軽量同期
cd backend
npx ts-node scripts/light-sync.ts

# フル同期
cd backend
npx ts-node run-full-sync-once.ts
```

---

## トラブルシューティング

### タスクが実行されない

1. タスクスケジューラでタスクの「履歴」タブを確認
2. エラーコードを確認
3. ログファイルを確認

### クォータエラーが発生する

軽量同期はスプレッドシートデータを30分間キャッシュするため、クォータ消費は最小限です。
それでもエラーが発生する場合は、同期間隔を15分に延長してください。

---

## 同期戦略のまとめ

| 同期タイプ | 頻度 | 対象 | クォータ消費 |
|-----------|------|------|------------|
| 軽量同期 | 10分ごと | 新規追加 + 「追客中」売主の更新 | 最小（30分キャッシュ） |
| フル同期 | 1日2回 | 全データ | 大 |

### 同期タイミングの例

- **08:00**: フル同期（朝）
- **08:10**: 軽量同期
- **08:20**: 軽量同期（キャッシュ使用）
- **08:30**: 軽量同期（キャッシュ使用）
- **08:40**: 軽量同期（キャッシュ期限切れ、再取得）
- ...
- **18:00**: フル同期（夕方）

**この設定により、スプレッドシートの変更は最大10分後にはDBに反映されます。**
