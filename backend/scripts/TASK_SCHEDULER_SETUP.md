# Windowsタスクスケジューラ設定ガイド

## 概要

PCが起動している間、自動的に同期を実行します。

- **軽量同期**: 5分ごと（最後の20行のみ、新規追加検出）
- **フル同期**: 1日1回（全データ同期）

---

## 設定手順

### 1. タスクスケジューラを開く

1. `Win + R` を押す
2. `taskschd.msc` と入力してEnter

---

### 2. 軽量同期タスクを作成

1. 右側の「タスクの作成」をクリック

#### 全般タブ
- **名前**: `売主リスト軽量同期`
- **説明**: `5分ごとにスプレッドシートの最後の20行を確認して新規売主を追加`
- **セキュリティオプション**: 「ユーザーがログオンしているときのみ実行する」を選択

#### トリガータブ
1. 「新規」をクリック
2. **タスクの開始**: `スケジュールに従う`
3. **設定**: `毎日`
4. **開始**: `2026/01/31 08:00:00`
5. **詳細設定**:
   - ✅ 「繰り返し間隔」: `5分間`
   - 「継続時間」: `無期限`
6. 「OK」をクリック

#### 操作タブ
1. 「新規」をクリック
2. **操作**: `プログラムの開始`
3. **プログラム/スクリプト**: `C:\Users\kunih\sateituikyaku\backend\scripts\run-light-sync.bat`
4. 「OK」をクリック

#### 条件タブ
- ✅ 「コンピューターをAC電源で使用している場合のみタスクを開始する」のチェックを外す
- ✅ 「コンピューターがアイドル状態の場合のみタスクを開始する」のチェックを外す

#### 設定タブ
- ✅ 「タスクを要求時に実行する」
- ✅ 「スケジュールされた時刻にタスクを開始できなかった場合、すぐにタスクを実行する」
- 「タスクが既に実行中の場合に適用される規則」: `新しいインスタンスを開始しない`

5. 「OK」をクリックして保存

---

### 3. フル同期タスクを作成（オプション）

1. 右側の「タスクの作成」をクリック

#### 全般タブ
- **名前**: `売主リストフル同期`
- **説明**: `1日1回、全売主データを同期`

#### トリガータブ
1. 「新規」をクリック
2. **タスクの開始**: `スケジュールに従う`
3. **設定**: `毎日`
4. **開始**: `2026/01/31 12:00:00`（昼休み時間など）
5. 「OK」をクリック

#### 操作タブ
1. 「新規」をクリック
2. **操作**: `プログラムの開始`
3. **プログラム/スクリプト**: `C:\Users\kunih\sateituikyaku\backend\scripts\run-full-sync.bat`
4. 「OK」をクリック

5. 「OK」をクリックして保存

---

## ログの確認

同期ログは以下のファイルに出力されます：

- **軽量同期**: `backend/logs/light-sync.log`
- **フル同期**: `backend/logs/full-sync.log`

```bash
# 最新のログを確認
type backend\logs\light-sync.log
```

---

## 手動実行

タスクを手動で実行するには：

1. タスクスケジューラでタスクを右クリック
2. 「実行」をクリック

または、コマンドラインから：

```bash
# 軽量同期
cd backend
npx ts-node scripts/light-sync.ts

# フル同期
cd backend
npx ts-node run-full-sync-once.ts
```

---

## トラブルシューティング

### タスクが実行されない

1. タスクスケジューラでタスクの「履歴」タブを確認
2. エラーコードを確認
3. ログファイルを確認

### クォータエラーが発生する

軽量同期は最後の20行のみを取得するため、クォータ消費は最小限です。
それでもエラーが発生する場合は、同期間隔を10分に延長してください。

---

## 同期戦略のまとめ

| 同期タイプ | 頻度 | 対象 | クォータ消費 |
|-----------|------|------|------------|
| 軽量同期 | 5分ごと | 最後の20行 | 最小 |
| フル同期 | 1日1回 | 全データ | 大 |

**この設定により、PCが起動している間は自動的に新規売主が追加されます。**
